C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE PRINCIPAL_MF
OBJECT MODULE PLACED IN .\hex\Principal_MF.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Principal_MF.C LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\libreria) DEBUG O
                    -BJECTEXTEND TABS(2) OBJECT(.\hex\Principal_MF.obj)

line level    source

   1          #include <at89c51xd2.h>
   2                      
   3          #include <stdio.h>          //                            *
   4          #include <INTRINS.H>        //                            *
   5          #include <math.h>                   //                            *          
   6          #include <string.h>
   7          #include "display.h"        //                            *
   8          #include "wiegand.h"
   9          #include "uart.h"
  10          #include "confiwiegand.h"
  11          //*******************************************************************************************
  12          //  DEFINICION DE IO DEL MICROCONTROLADOR                         *
  13          //*******************************************************************************************
  14          //sbit sw_1 = P1^2;         //Direccion                       *
  15          //sbit sw_2 = P1^3;         //Direccion                       *
  16          sbit ledv = P1^4;         //Led del boton expedidor               *
  17          sbit lock1  = P1^6;         //Relevo de Entrada                   *
  18          sbit lock2  = P1^5;         //Relevo de Salida (Inhabilitado Proc. Aux usa ERR IMP) *
  19          
  20          sbit msg1  = P0^0;          //Relevo de Salida (AUDIO)                *
  21          sbit msg2  = P0^1;          //Relevo de Salida (AUDIO)                *
  22          sbit msg3  = P0^2;          //Relevo de Salida (AUDIO)                *
  23          sbit msg4  = P0^3;          //Relevo de Salida (AUDIO)                *
  24          
  25          sbit automovil  = P1^7;       //Entrada sensor automovil / Cajon Monedero       *
  26          sbit SignalAcceso = P3^7;     //Sigue la señal de Sensor                *
  27          sbit busy=P3^5;             //                            *
  28          sbit ready=P3^4;          //                            *
  29          sbit bus_clk=P3^6;          //  
  30          //sbit RS = P1^0 ;                  /* define I/O functions     */
  31          //sbit E =  P1^1 ;                  /* P3.5             */
  32          
  33          
  34          //                        */
  35          //*******************************************************************************************
  36           unsigned char sin_sensor   []= "ERROR:  LOOP 1  " ;
  37           unsigned char linea        []= " FUERA DE LINEA " ;
  38           unsigned char err_mifare   []= " ERROR MIFARE   " ;
  39           unsigned char err_cod      []= "ERROR COD. PARQ." ;
  40           unsigned char err_in       []= "  SIN INGRESO   " ;
  41           unsigned char err_sinpago  []= "NO REGISTRA PAGO" ;
  42           unsigned char err_gracia   []= "EXCEDE T.GRACIA " ;
  43          
  44           unsigned char MSGnegado    []= " ACCESO NEGADO  " ;
  45           unsigned char err_out      []= "   SIN SALIDA   " ;
  46           unsigned char err_data     []= "ERROR GRABACION " ;
  47           unsigned char err_Caja     []= "ACERQUESE A CAJA" ;
  48           unsigned char serie        []= "SERIE:          " ;
  49           unsigned char matchPlate   []= "COMPARANDO PLACA" ;
  50           unsigned char tarjeta_venc []= "TARJETA VENCIDA " ;
  51          //******************************************************************************************* 
  52          
  53          #define    cte_seg  0x1c
  54          #define    cte_retry  0x2a
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 2   

  55          
  56          
  57           unsigned char seg,k;
  58          
  59           unsigned char g_cContByteRx=0;
  60           unsigned char g_cDirBoard=0x31;
  61          
  62           unsigned char num_chr;
  63           unsigned char g_cRelevos;
  64           unsigned int TimeOut_Codigo;
  65           unsigned int TimeOut_Wiegand;
  66           unsigned char TimeOutLinea;
  67           unsigned char len_buffer;
  68           unsigned char num_data;
  69          
  70           unsigned int iTimeEsperaRtaLPR=0;
  71          
  72           unsigned char Ini_Fecha;
  73           unsigned char Ini_Dcto;
  74          
  75           unsigned char YearIn;
  76           unsigned char MonthIn;
  77           unsigned char DayIn;
  78           unsigned char HourIn;
  79           unsigned char MinutIn;
  80          
  81           unsigned char YearOut;
  82           unsigned char MonthOut;
  83           unsigned char DayOut;
  84           unsigned char HourOut;
  85           unsigned char MinutOut;
  86          
  87           unsigned char Tipo_Vehiculo;
  88           unsigned char xTipo_Vehiculo;
  89           unsigned int TimeOut_Send_Acceso=0;
  90          
  91           unsigned char NumDatRetry=0;
  92          
  93          //ESTADOR RECEPCION SOFTWARE
  94          
  95          #define ESPERA_RX       0
  96          #define VER_DIR         1
  97          #define VER_COMANDO       2
  98          #define POLL_COM_SOF      3
  99          #define WRITE_COM_SOF     4
 100          #define RECEPCION_STR_SOF_STX 5
 101          #define SAVE_STR_SOF      6
 102          #define ANALICE_STR_SOF     7
 103          #define RECEPCION_ID      8
 104          
 105          
 106          #define TAMANO_RX_COM_SOFT  60  
 107          #define TAMANO_TX_COM_SOFT  50
 108          
 109          //ESTADOR TRANSMICION SOFTWARE
 110          
 111          #define SIN_LECTURA_TX  0x00
 112          #define LECTURA_COD_TX  0x01
 113          #define LECTURA_WIEG_TX 0x02
 114          #define COD_PRINT_TX  0x04
 115          #define LPR_TX      0x08   //reconocimiento placa
 116          
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 3   

 117          unsigned char g_cEstadoComSoft=ESPERA_RX;
 118          unsigned char g_cEstadoTxSoft=SIN_LECTURA_TX;
 119          
 120          
 121          
 122          
 123          unsigned char g_scArrRxComSoft[TAMANO_RX_COM_SOFT];
 124          unsigned char g_scArrTxComSoft[TAMANO_TX_COM_SOFT];
 125          
 126          unsigned char g_scArrDisplay[32];
 127          
 128          unsigned char xdata buffer_bus[30];
 129          
 130           unsigned char xdata BufferRetry[20];
 131          
 132          
 133           unsigned char xdata buffer_ticket[20];
 134          
 135           unsigned char xdata buffer_placa[10];
 136          
 137           extern unsigned char xdata buffer_wie[];
 138           unsigned char xdata buffer_wieLPR[4];
 139           unsigned char xdata buffer_Cupo[5];    //buffer donde almaceno el numero de cupos jp
 140          
 141          
 142          
 143           unsigned char  NumDatosPlate=0;
 144           unsigned char  Max_Len_Placa=0;
 145           unsigned char  NumChrTicket=0;
 146           unsigned char  Num_Char_LPR=0;
 147          
 148           unsigned char temp;
 149           unsigned char Rechazo;
 150           unsigned char Seg_OFF=5;
 151           unsigned char TimeRetryCmd=0;
 152           char nbitsW;
 153           unsigned char Cod_Dcto;
 154           
 155           
 156           unsigned int OpenMensual_Apx=0;
 157          
 158          #define ENQ 5
 159          #define EOT 4
 160          #define ACK 6
 161          #define STX 2
 162          #define ETX 3
 163          #define CR  0x0d
 164          #define LF  0x0a
 165          
 166          #define GRACIAS     0X01
 167          #define BIENVENIDO    0X02
 168          #define NO_REGIST   0X04
 169          #define LOT_FULL    0X05
 170          #define ERROR_LOOP  0x06
 171          #define EXCEDE_HORARIO  0X07
 172          #define MENSUAL_NO_PAGO 0X08
 173          #define UN_MOMENTO      0X09
 174          
 175          #define SOLICITA_EVN  0XAA
 176          
 177          #define NO_MENSUAL  0XB1
 178          #define NO_IN_PARK  0XB2
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 4   

 179          #define IN_PARK   0Xb3
 180          #define EXPIRO    0Xb4
 181          #define HORARIO   0Xb5
 182          #define OFF_LINE  0XB6
 183          #define ON_LINE   0XB7
 184          #define IN_HORARIO  0Xb8
 185          #define DiaX    0XB9
 186          
 187          #define ACCESO    0Xab
 188          
 189          
 190          #define PICO_PLACA    0XF3
 191          #define RECHAZADA   0XF9
 192          #define SIN_TARJETAS    0XFA
 193          
 194          
 195          #define TIMEW   0x1e          //Tiempo para indicar TimeOut
 196          #define T_MS    20          // Base para 1ms en Espera a tx Bus
 197          #define MAX_CHR   30          // Maximo Numero CHR a recibir del secundario
 198          
 199          
 200          #define LOOP  0
 201          #define CARD  1
 202          //#define LONGWIEGAND 26
 203          
 204           bit sendactive=0;                // flag: marks transmitter active
 205           bit rx_dat=0;
 206           bit toggle=0;
 207          
 208           bit rx_serie=0;
 209           bit bandera_rx_soft=0;
 210           bit txACK=0;
 211          
 212           bit inicio_wiegand;
 213           bit lectura_wiegand;
 214          // bit flanco_wiegand;
 215          
 216           bit audio1=0;
 217           bit audio2=0;                
 218           bit audio3=0;
 219           bit audio4=0;
 220          
 221           bit msg_error=0;      
 222           bit notifyEVP;
 223           bit retry;
 224           bit FueraLinea=0;
 225           bit ACCESO_USE_LPR;
 226           bit Flag_Dcto=0;
 227           bit datos_validos=0;
 228           bit Dif_Mot_Car=0;
 229           bit send_markCashierAut;
 230           bit Send_Wiegand=0;
 231           bit InhabilitaPulsoEvPOut=0;
 232           bit Send_Tipo_Veh=CARD;    //modificado 23/01/2019 jp          LOOP;
 233           bit SerieOK=0;
 234           bit Dato_OffLine=0;
 235           bit Off_Line_Salida=0;
 236           bit Atascado=0;
 237           bit Habilita_Lectura=1;
 238          
 239           bit Dato_Placa=0;
 240           bit Tiquete_Placa=0;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 5   

 241           bit Tiquete_Salida=0;
 242          
 243           bit Tx_Acceso=0;
 244           bit SalidaW=0;
 245           bit Central_ID_OFFLINE=0;
 246           bit OrigenTipoVeh=CARD;
 247           bit ErrorTx=0;
 248           bit RetryCmd=0;
 249          
 250          
 251          extern unsigned char completo;
 252          extern  unsigned char codebits[];
 253          extern  unsigned char nex_bit;
 254          extern  unsigned char facility_code;
 255          extern  unsigned char card_number;
 256          extern  unsigned char card_number1;
 257          extern  unsigned char card_number2;
 258          
 259          //*******************************************************************************************
 260          void Pulso_Bus(void)
 261          {
 262   1        bus_clk=0;
 263   1        wait_ancho();
 264   1        wait_ancho();
 265   1        wait_ancho();
 266   1        bus_clk=1;
 267   1        wait_ancho();
 268   1        wait_ancho();
 269   1      }
 270          
 271          //********************************************************************************************************
             -******
 272          bit tx_bus (unsigned char num_chr)
 273          {
 274   1          unsigned char j;
 275   1        long int cont;
 276   1        bit timeOut;
 277   1      
 278   1        bus_clk=1;            // Asegura pulso de Clk en 1
 279   1        timeOut=0;            // Borra Bandera de Time Out
 280   1        busy=0;             // Genera Peticion de Atencion al Secundario
 281   1        cont=T_MS*200;          // 500 ms  cambio echo jp 100 por 200
 282   1      //----------------------------------------
 283   1        while ((ready==1)&&(timeOut==0))
 284   1        {
 285   2          cont--;
 286   2          if (cont==0)
 287   2          {
 288   3            timeOut=1;
 289   3            bus_clk=1;
 290   3            ready=1;
 291   3            busy=1;
 292   3          }
 293   2        }
 294   1      //---------------------------------------
 295   1          if (timeOut==0)
 296   1        {
 297   2          for (j=0; j<num_chr; j++)
 298   2          {
 299   3              P2=buffer_bus[j];
 300   3            Pulso_Bus();
 301   3          }
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 6   

 302   2      
 303   2        }
 304   1      //---------------------------------------
 305   1        bus_clk=1;
 306   1      //  ready=1;
 307   1        busy=1;
 308   1        
 309   1        if (timeOut==0)
 310   1        {
 311   2          wait_long();
 312   2          wait_long();
 313   2          wait_long();
 314   2          wait_long();
 315   2      //    wait_long();
 316   2        }
 317   1        return timeOut;
 318   1      }
 319          
 320          //********************************************************************************************************
             -******
 321          
 322          //********************************************************************************************************
             -******
 323          //*******************************************************************************************
 324          void send_dataCLK(unsigned char fc, dir)
 325          {
 326   1        unsigned int valor;
 327   1        unsigned char centena, decena, unidad;
 328   1        valor=0;
 329   1      
 330   1        centena=0;
 331   1        decena=0;
 332   1        unidad=0;
 333   1         
 334   1        while (fc>=0x064)         // resto 100
 335   1        {
 336   2          fc=fc-0x64;
 337   2          centena=centena+1;
 338   2        }
 339   1        while (fc>=0x0a)        // resto 10
 340   1        {
 341   2          fc=fc-0x0a;
 342   2          decena=decena+1;
 343   2        }
 344   1        unidad=fc;
 345   1      
 346   1      //  vdato(centena|0x30);
 347   1        g_scArrTxComSoft[dir]=(decena|0x30);
 348   1          g_scArrTxComSoft[dir+1]=(unidad|0x30);
 349   1      }
 350          
 351          //********************************************************************************************************
             -******
 352          void relevos_aux(void)
 353          {
 354   1        (audio1==1)?(msg1=1):(msg1=0);
 355   1        (audio2==1)?(msg2=1):(msg2=0);
 356   1        (audio3==1)?(msg3=1):(msg3=0);
 357   1        (audio4==1)?(msg4=1):(msg4=0);
 358   1      }
 359          //********************************************************************************************************
             -******
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 7   

 360          //********************************************************************************************
 361          void rx_bus (void)
 362          {
 363   1        long int count;
 364   1        unsigned char timeOut,j=0;
 365   1      
 366   1      
 367   1        
 368   1        busy=1;
 369   1        num_data=0;
 370   1        if (ready==0)
 371   1        {
 372   2          timeOut=0;
 373   2          busy=0;
 374   2          for (j=0; j<MAX_CHR; j++)
 375   2          {                  //100000
 376   3            count=60;
 377   3            while ((bus_clk==1)&&(ready==0)&&(timeOut==0))
 378   3            {
 379   4              count--;
 380   4              if (count==0)
 381   4              {
 382   5                timeOut=1;
 383   5                j=MAX_CHR+1;
 384   5              }   
 385   4            }  
 386   3            if ((bus_clk==0)&&(timeOut==0)&&(ready==0))
 387   3            {
 388   4              buffer_bus[j]=P2;
 389   4              num_data++; 
 390   4              count=35;       //50000
 391   4              while ((bus_clk==0)&&(timeOut==0))
 392   4              {
 393   5                buffer_bus[j]=P2;
 394   5                count--;
 395   5                if (count==0)
 396   5                {
 397   6                  timeOut=1;
 398   6                  j=MAX_CHR+1;
 399   6                }       
 400   5              }
 401   4            }
 402   3            if (ready==1)
 403   3            {
 404   4              j=MAX_CHR+1;
 405   4            }
 406   3          }
 407   2          }
 408   1        busy=1;    
 409   1      
 410   1      }
 411          
 412          //********************************************************************************************************
             -******//**************************************************************************************************************
 413          //*******************************************************************************************
 414          //    FUNCIONES PARA VISUALIZAR FECHA HORA                        *
 415          //*******************************************************************************************
 416           void vdata_clk (unsigned char data_clk) 
 417           {
 418   1       
 419   1       unsigned int temp;
 420   1      
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 8   

 421   1       temp=data_clk;
 422   1       temp=temp & 0xf0;
 423   1       temp>>=4;
 424   1       temp=temp|0x30;
 425   1       vdato(temp);
 426   1      
 427   1       temp=data_clk;
 428   1       temp=temp & 0x0f;
 429   1       temp=temp|0x30;
 430   1       vdato(temp);
 431   1      
 432   1      }
 433          
 434          //*******************************************************************************************
 435          void SendMsg(unsigned char tipo)
 436          {
 437   1        unsigned char i;
 438   1      
 439   1      
 440   1          buffer_bus[0]=STX;
 441   1          switch (tipo)
 442   1          {
 443   2            case GRACIAS:
 444   2              buffer_bus[1]='V';      
 445   2        
 446   2            break;
 447   2        
 448   2        
 449   2            case BIENVENIDO:
 450   2              buffer_bus[1]='O';
 451   2         
 452   2            break;
 453   2          }
 454   1         
 455   1          for(i=21; i<=37; i++)
 456   1          {
 457   2            buffer_bus[i-19]=g_scArrRxComSoft[i];
 458   2          }
 459   1          buffer_bus[18]=ETX;
 460   1          
 461   1          
 462   1      
 463   1          if (ready==1)
 464   1          {
 465   2            ErrorTx=tx_bus(19);
 466   2            if (ErrorTx==1)
 467   2            {
 468   3              for (i=0; i<19; i++)
 469   3              {
 470   4                BufferRetry[i]=buffer_bus[i];
 471   4              }
 472   3              NumDatRetry=19;
 473   3              TimeRetryCmd=cte_seg;
 474   3            }
 475   2          }
 476   1          else
 477   1          {
 478   2            for (i=0; i<19; i++)
 479   2            {
 480   3              BufferRetry[i]=buffer_bus[i];
 481   3            }
 482   2            NumDatRetry=19;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 9   

 483   2            TimeRetryCmd=cte_seg;
 484   2            
 485   2          }
 486   1      
 487   1                    
 488   1      
 489   1      }
 490          //********************************************************************************************************
             -******
 491          void SendRtaBus (unsigned char Respuesta)
 492          {
 493   1        if (ready==1)
 494   1        {
 495   2          buffer_bus[0]=Respuesta;    
 496   2          ErrorTx=tx_bus(1);
 497   2          if (ErrorTx==1)
 498   2          {
 499   3            NumDatRetry=1;
 500   3            BufferRetry[0]=Respuesta;
 501   3            TimeRetryCmd=cte_retry;
 502   3          }     
 503   2        }
 504   1        else
 505   1        {
 506   2          NumDatRetry=1;
 507   2          BufferRetry[0]=Respuesta;
 508   2          TimeRetryCmd=cte_retry;
 509   2        } 
 510   1      }
 511          //********************************************************************************************************
             -******
 512          //
 513          //********************************************************************************************************
             -******
 514          void AtencComSoft(void)
 515          {
 516   1      
 517   1        char i, longTx;
 518   1        switch (g_cEstadoComSoft)
 519   1        {
 520   2      //********************************************************************************************************
             -******
 521   2          case POLL_COM_SOF:
 522   2      //--------------------------------------------------------------------------------------------------------
             -------
 523   2      //  COLOCAR BUFER DE TRANSMICION INDEPENDIENTE PARA CADA SITUACION
 524   2      //--------------------------------------------------------------------------------------------------------
             -------
 525   2            if (g_cEstadoTxSoft==SIN_LECTURA_TX)
 526   2            {       
 527   3              tx_chr(EOT);                        //No hay Novedad 
 528   3              g_cEstadoComSoft=ESPERA_RX;
 529   3              
 530   3              if (SignalAcceso==1)
 531   3              {
 532   4                buffer_bus[0]=SOLICITA_EVN;
 533   4                tx_bus(1);
 534   4              }   
 535   3              
 536   3            }
 537   2      //--------------------------------------------------------------------------------------------------------
             -------
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 10  

 538   2            else if ((g_cEstadoTxSoft&LECTURA_COD_TX)==LECTURA_COD_TX)          //Lectura Cod Barras
 539   2            {
 540   3                
 541   3              if (Tiquete_Placa==1)
 542   3              {
 543   4                longTx=0;
 544   4                g_scArrTxComSoft[longTx++]=STX;
 545   4                (send_markCashierAut==0)?(g_scArrTxComSoft[longTx++]='a'):(g_scArrTxComSoft[longTx++]='C');
 546   4                
 547   4                for (i=0; i<NumChrTicket; i++)
 548   4                  {
 549   5                  g_scArrTxComSoft[longTx++]=buffer_ticket[i];
 550   5                  }
 551   4                g_scArrTxComSoft[longTx++]=',';
 552   4                if (Tiquete_Salida==1)
 553   4                {
 554   5                  g_scArrTxComSoft[longTx++]=Cod_Dcto;
 555   5                }
 556   4                else
 557   4                {
 558   5                  g_scArrTxComSoft[longTx++]='0';
 559   5                }
 560   4                
 561   4                
 562   4                if (OrigenTipoVeh==CARD)
 563   4                {
 564   5                  if (Tipo_Vehiculo=='H')         // Heavy
 565   5                  {
 566   6                    g_scArrTxComSoft[longTx++]='0';   // Carro=0
 567   6                  }
 568   5                  else if (Tipo_Vehiculo=='T')      // Truck
 569   5                  {
 570   6                    g_scArrTxComSoft[longTx++]='0';   // Carro=0
 571   6                  }
 572   5                  else if(Tipo_Vehiculo=='M')       // Motocycle
 573   5                  {
 574   6                    g_scArrTxComSoft[longTx++]='1';   // Moto=1
 575   6                  }
 576   5                  else if(Tipo_Vehiculo=='C')       // Carro
 577   5                  {
 578   6                    g_scArrTxComSoft[longTx++]='0';   // Carro=0      modifica 24/01/2019    no  funciono
 579   6                  }
 580   5                  else
 581   5                  {
 582   6                    
 583   6                    if (Dif_Mot_Car==1)
 584   6                    {
 585   7                      if (automovil==0)
 586   7                      {
 587   8                        if(SignalAcceso==0)              //  Se modifica 24/01/2019
 588   8                        {
 589   9                        g_scArrTxComSoft[longTx++]='0';       // Carro=0  
 590   9                        }else { g_scArrTxComSoft[longTx++]='1';}    // Moto=1
 591   8                      }    
 592   7                      else
 593   7                      {
 594   8                        g_scArrTxComSoft[longTx++]='1';   // Moto=1
 595   8                      }
 596   7                    }
 597   6                    else
 598   6                    {
 599   7                      g_scArrTxComSoft[longTx++]='0';   // Carro=0     modificado 24/01/2019
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 11  

 600   7                    }
 601   6                    
 602   6                  }
 603   5                }
 604   4                else
 605   4                {
 606   5      
 607   5                    if (Dif_Mot_Car==1)
 608   5                    {
 609   6                      if (automovil==0)
 610   6                      {
 611   7                        if(SignalAcceso==0)              //  Se modifica 24/01/2019
 612   7                        {
 613   8                        g_scArrTxComSoft[longTx++]='0';   // Carro=0  modificado jp 24/01/2019   no funciona
 614   8                        }else { g_scArrTxComSoft[longTx++]='1';}
 615   7                      }
 616   6                      else
 617   6                      {
 618   7                        g_scArrTxComSoft[longTx++]='1';   // Moto=1
 619   7                      }
 620   6                    }
 621   5                    else
 622   5                    {
 623   6                      g_scArrTxComSoft[longTx++]='0';   // Carro=0     modificado jp 24/01/2019 nofunciona
 624   6                    }
 625   5                }
 626   4                
 627   4      
 628   4                g_scArrTxComSoft[longTx++]=',';
 629   4      
 630   4                send_dataCLK((YearIn-0x30),longTx);
 631   4                longTx=longTx+2;
 632   4                send_dataCLK((MonthIn-0x30),longTx);
 633   4                longTx=longTx+2;
 634   4                send_dataCLK((DayIn-0x30),longTx);
 635   4                longTx=longTx+2;
 636   4                send_dataCLK((HourIn-0x30),longTx);
 637   4                longTx=longTx+2;
 638   4                send_dataCLK((MinutIn-0x30),longTx);
 639   4                longTx=longTx+2;
 640   4      
 641   4                
 642   4                if (send_markCashierAut==0)
 643   4                {
 644   5                  g_scArrTxComSoft[longTx++]=',';
 645   5                  if (Tiquete_Salida==1)
 646   5                  {
 647   6        
 648   6                    send_dataCLK((YearOut-0x30),longTx);
 649   6                    longTx=longTx+2;
 650   6                    send_dataCLK((MonthOut-0x30),longTx);
 651   6                    longTx=longTx+2;
 652   6                    send_dataCLK((DayOut-0x30),longTx);
 653   6                    longTx=longTx+2;
 654   6                    send_dataCLK((HourOut-0x30),longTx);
 655   6                    longTx=longTx+2;
 656   6                    send_dataCLK((MinutOut-0x30),longTx);
 657   6                    longTx=longTx+2;
 658   6                    g_scArrTxComSoft[longTx++]=',';
 659   6        
 660   6                    g_scArrTxComSoft[longTx++]=' ';
 661   6        
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 12  

 662   6                    g_scArrTxComSoft[longTx++]=',';
 663   6                    g_scArrTxComSoft[longTx++]=ETX;         
 664   6                    EscribirCadenaSoft(longTx);     
 665   6        
 666   6                  }
 667   5                  else
 668   5                  {
 669   6                    g_scArrTxComSoft[longTx++]='0';
 670   6                    g_scArrTxComSoft[longTx++]='0';
 671   6                    g_scArrTxComSoft[longTx++]='0';
 672   6                    g_scArrTxComSoft[longTx++]='0';
 673   6                    g_scArrTxComSoft[longTx++]='0';
 674   6                    g_scArrTxComSoft[longTx++]='0';
 675   6                    g_scArrTxComSoft[longTx++]='0';
 676   6                    g_scArrTxComSoft[longTx++]='0';
 677   6                    g_scArrTxComSoft[longTx++]='0';
 678   6                    g_scArrTxComSoft[longTx++]='0';
 679   6        
 680   6                    g_scArrTxComSoft[longTx++]=',';
 681   6                    for (i=0; i<Num_Char_LPR; i++)
 682   6                    {
 683   7                      g_scArrTxComSoft[longTx++]=buffer_placa[i];
 684   7                    }
 685   6                    g_scArrTxComSoft[longTx++]=',';
 686   6                    g_scArrTxComSoft[longTx++]=ETX;         
 687   6                    EscribirCadenaSoft(longTx);     
 688   6                  }
 689   5      
 690   5                }
 691   4                else
 692   4                {
 693   5                  g_scArrTxComSoft[longTx++]=ETX;
 694   5                  EscribirCadenaSoft(longTx);
 695   5                }
 696   4          
 697   4      
 698   4              }
 699   3              else
 700   3              {
 701   4                g_scArrTxComSoft[0]=STX;
 702   4                
 703   4                if (Rechazo==0)
 704   4                {
 705   5                  (send_markCashierAut==0)?(g_scArrTxComSoft[1]='A'):(g_scArrTxComSoft[1]='C');
 706   5                }
 707   4                else
 708   4                {
 709   5                  g_scArrTxComSoft[1]=Rechazo;
 710   5                }
 711   4                
 712   4                
 713   4                longTx=len_buffer;
 714   4                for (i=0; i<len_buffer; i++)
 715   4                  {
 716   5                  g_scArrTxComSoft[i+2]=buffer_ticket[i];
 717   5                  }
 718   4                g_scArrTxComSoft[longTx+2]=',';
 719   4        //--------------------------------------------------------------------
 720   4                if (Flag_Dcto==1)
 721   4                {
 722   5                  g_scArrTxComSoft[longTx+3]=Cod_Dcto;
 723   5                }
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 13  

 724   4                else
 725   4                {         
 726   5                  g_scArrTxComSoft[longTx+3]='0';
 727   5                }
 728   4        //-------------------------------------------------------------------------------
 729   4                if (Send_Tipo_Veh==CARD)
 730   4                {
 731   5                  if (Tipo_Vehiculo=='H')         // Heavy
 732   5                  {
 733   6                    xTipo_Vehiculo=4;
 734   6                  }
 735   5                  else if (Tipo_Vehiculo=='T')      // Truck
 736   5                  {
 737   6                    xTipo_Vehiculo=3;
 738   6                  }
 739   5                  else if(Tipo_Vehiculo=='B')         // Bycicle
 740   5                  {
 741   6                    xTipo_Vehiculo=2;
 742   6                  }
 743   5                  else if(Tipo_Vehiculo=='M')       // Motocycle
 744   5                  {
 745   6                    xTipo_Vehiculo=1;
 746   6                  }
 747   5                  else if(Tipo_Vehiculo=='C')       // Carro
 748   5                  {
 749   6                    xTipo_Vehiculo=0;
 750   6                  }
 751   5                  else                  // Sin categoria
 752   5                  {
 753   6        
 754   6                    if (Dif_Mot_Car==1)
 755   6                    {
 756   7                      if (automovil==0)
 757   7                      {
 758   8                        xTipo_Vehiculo=0;     //Carro =0;
 759   8                      }
 760   7                      else
 761   7                      {
 762   8                        xTipo_Vehiculo=1;       //MOTO = 1
 763   8                      }
 764   7                    }
 765   6                    else
 766   6                    {
 767   7                      xTipo_Vehiculo=0;       //Carro =0;
 768   7                    }
 769   6                    
 770   6                  }
 771   5                  g_scArrTxComSoft[longTx+4]=xTipo_Vehiculo+0X30;
 772   5                }
 773   4                else
 774   4                {
 775   5                  if (Dif_Mot_Car==1)
 776   5                  {
 777   6                    if (automovil==0)
 778   6                    {
 779   7                      g_scArrTxComSoft[longTx+4]='0';   //Carro =0;   modificado 23/01/2019 jp
 780   7                    }
 781   6                    else
 782   6                    {
 783   7                      g_scArrTxComSoft[longTx+4]='1';     //MOTO = 1
 784   7                    }
 785   6                  }
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 14  

 786   5                  else
 787   5                  {
 788   6                    g_scArrTxComSoft[longTx+4]='0';   //Carro =0;
 789   6                  }
 790   5                  }
 791   4        //--------------------------------------------------------------------------------          
 792   4                if (send_markCashierAut==1)
 793   4                {
 794   5                  g_scArrTxComSoft[longTx+5]=',';
 795   5        
 796   5                  longTx=longTx+6;
 797   5                  send_dataCLK((YearIn-0x30),longTx);
 798   5                  longTx=longTx+2;
 799   5                  send_dataCLK((MonthIn-0x30),longTx);
 800   5                  longTx=longTx+2;
 801   5                  send_dataCLK((DayIn-0x30),longTx);
 802   5                  longTx=longTx+2;
 803   5                  send_dataCLK((HourIn-0x30),longTx);
 804   5                  longTx=longTx+2;
 805   5                  send_dataCLK((MinutIn-0x30),longTx);
 806   5                  longTx=longTx+2;
 807   5                  g_scArrTxComSoft[longTx]=ETX;
 808   5                  EscribirCadenaSoft(longTx+1);
 809   5        
 810   5        //          g_scArrTxComSoft[longTx+6]=YearIn;    
 811   5        //          g_scArrTxComSoft[longTx+7]=MonthIn;   
 812   5        //          g_scArrTxComSoft[longTx+8]=DayIn;   
 813   5        //          g_scArrTxComSoft[longTx+9]=HourIn;    
 814   5        //          g_scArrTxComSoft[longTx+10]=MinutIn;    
 815   5        //          g_scArrTxComSoft[longTx+11]=ETX;    
 816   5        //            EscribirCadenaSoft(longTx+12);
 817   5           
 818   5                }
 819   4                else
 820   4                {
 821   5                  g_scArrTxComSoft[longTx+5]=ETX;   
 822   5                    EscribirCadenaSoft(longTx+6);
 823   5        
 824   5                }
 825   4              }
 826   3              
 827   3              
 828   3      
 829   3      //        send_markCashierAut=0;
 830   3                g_cEstadoComSoft=ESPERA_RX;
 831   3            }
 832   2      //--------------------------------------------------------------------------------------------------------
             ----------
 833   2            else if ((g_cEstadoTxSoft&LECTURA_WIEG_TX)==LECTURA_WIEG_TX)        // Lectura Wiegand Lector 1
 834   2            {
 835   3                  Send_Wiegand=1;
 836   3                seg=cte_seg;
 837   3                TH0=0X00;                                           
 838   3                TL0=0X00;
 839   3                TF0=0;
 840   3      
 841   3                if (Dato_OffLine==0)
 842   3                 {
 843   4                  if (SalidaW==1)
 844   4                  {
 845   5                    //SalidaW=0;
 846   5      //---------------------;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 15  

 847   5      
 848   5                  g_scArrTxComSoft[0]=STX;
 849   5                  g_scArrTxComSoft[1]='w';
 850   5                  g_scArrTxComSoft[2]=((buffer_wie[0]>>4)&0X0f)+0X30;
 851   5                  g_scArrTxComSoft[3]=(buffer_wie[0]&0X0F)+0X30;
 852   5                  g_scArrTxComSoft[4]=((buffer_wie[1]>>4)&0X0f)+0X30;
 853   5                  g_scArrTxComSoft[5]=(buffer_wie[1]&0X0f)+0X30;
 854   5                  g_scArrTxComSoft[6]=((buffer_wie[2]>>4)&0X0f)+0X30;
 855   5                  g_scArrTxComSoft[7]=(buffer_wie[2]&0X0f)+0X30;
 856   5        
 857   5                    g_scArrTxComSoft[8]=',';
 858   5                  g_scArrTxComSoft[9]='0';
 859   5        
 860   5      //-------------------------------------------------------------------------------
 861   5                  if (Send_Tipo_Veh==CARD)
 862   5                  {
 863   6                    if (Tipo_Vehiculo=='H')         // Heavy
 864   6                    {
 865   7                      xTipo_Vehiculo=4;
 866   7                    }
 867   6                    else if (Tipo_Vehiculo=='T')      // Truck
 868   6                    {
 869   7                      xTipo_Vehiculo=3;
 870   7                    }
 871   6                    else if(Tipo_Vehiculo=='B')         // Bycicle
 872   6                    {
 873   7                      xTipo_Vehiculo=2;
 874   7                    }
 875   6                    else if(Tipo_Vehiculo=='M')       // Motocycle
 876   6                    {
 877   7                      xTipo_Vehiculo=1;
 878   7                    }
 879   6                    else if(Tipo_Vehiculo=='C')       // Carro
 880   6                    {
 881   7                      xTipo_Vehiculo=0;
 882   7                    }
 883   6                    else                  // Sin categoria
 884   6                    {
 885   7          
 886   7                      if (Dif_Mot_Car==1)
 887   7                      {
 888   8                        if (automovil==0)
 889   8                        {
 890   9                          xTipo_Vehiculo=0;     //Carro =0;   modificado 23/01/2019   no funciona
 891   9                        }
 892   8                        else
 893   8                        {
 894   9                          xTipo_Vehiculo=1;       //MOTO = 1
 895   9                        }
 896   8                      }
 897   7                      else
 898   7                      {
 899   8                        xTipo_Vehiculo=0;       //Carro =0;
 900   8                      }
 901   7                      
 902   7                    }
 903   6                    g_scArrTxComSoft[10]=xTipo_Vehiculo+0X30;
 904   6                  }
 905   5                  else
 906   5                  {
 907   6                    if (Dif_Mot_Car==1)
 908   6                    {
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 16  

 909   7                      if (automovil==0)
 910   7                      {
 911   8                        g_scArrTxComSoft[10]='0';   //Carro =0;   no funcionamodificado 23/01/2019
 912   8                      }
 913   7                      else
 914   7                      {
 915   8                        g_scArrTxComSoft[10]='1';     //MOTO = 1
 916   8                      }
 917   7                    }
 918   6                    else
 919   6                    {
 920   7                      g_scArrTxComSoft[10]='0';     //Carro =0;
 921   7                    }
 922   6                    }
 923   5      //--------------------------------------------------------------------------------  
 924   5                      g_scArrTxComSoft[11]=',';
 925   5                  
 926   5      
 927   5                  send_dataCLK((YearIn-0x30),12);
 928   5                  send_dataCLK((MonthIn-0x30),14);
 929   5                  send_dataCLK((DayIn-0x30),16);
 930   5                  send_dataCLK((HourIn-0x30),18);
 931   5                  send_dataCLK((MinutIn-0x30),20);
 932   5      
 933   5                    
 934   5                    g_scArrTxComSoft[22]=',';
 935   5                  send_dataCLK((YearOut-0x30),23);
 936   5                  send_dataCLK((MonthOut-0x30),25);
 937   5                  send_dataCLK((DayOut-0x30),27);
 938   5                  send_dataCLK((HourOut-0x30),29);
 939   5                  send_dataCLK((MinutOut-0x30),31);
 940   5                  temp=33;
 941   5                  g_scArrTxComSoft[temp++]=',';
 942   5                    
 943   5                    if (Dato_Placa==1)
 944   5                    {
 945   6      //                Dato_Placa=0;
 946   6      //                for (i=0; i<NumDatosPlate-1; i++)
 947   6                      for (i=0; i<NumDatosPlate; i++)
 948   6                      {
 949   7                        g_scArrTxComSoft[temp++]=buffer_placa[i];
 950   7                      }
 951   6                      }
 952   5                    else
 953   5                    {
 954   6                        g_scArrTxComSoft[temp++]=' ';
 955   6                    }
 956   5                    g_scArrTxComSoft[temp++]=',';
 957   5                    g_scArrTxComSoft[temp++]=ETX;
 958   5                    EscribirCadenaSoft(temp);
 959   5      
 960   5      
 961   5      
 962   5      
 963   5      //---------------------
 964   5                  }
 965   4                  else
 966   4                  {
 967   5                    g_scArrTxComSoft[0]=STX;
 968   5                    g_scArrTxComSoft[1]='B';
 969   5                    g_scArrTxComSoft[2]=((buffer_wie[0]>>4)&0X0f)+0X30;
 970   5                    g_scArrTxComSoft[3]=(buffer_wie[0]&0X0F)+0X30;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 17  

 971   5                    g_scArrTxComSoft[4]=((buffer_wie[1]>>4)&0X0f)+0X30;
 972   5                    g_scArrTxComSoft[5]=(buffer_wie[1]&0X0f)+0X30;
 973   5                    g_scArrTxComSoft[6]=((buffer_wie[2]>>4)&0X0f)+0X30;
 974   5                    g_scArrTxComSoft[7]=(buffer_wie[2]&0X0f)+0X30;
 975   5          
 976   5                      g_scArrTxComSoft[8]=',';
 977   5                    g_scArrTxComSoft[9]='0';
 978   5          
 979   5                    if (Dif_Mot_Car==1)
 980   5                    {
 981   6                      if (automovil==0)
 982   6                      {
 983   7                        g_scArrTxComSoft[10]='0';   //Carro =0;
 984   7                      }
 985   6                      else
 986   6                      {
 987   7                        g_scArrTxComSoft[10]='1';     //MOTO = 1
 988   7                      }
 989   6                    }
 990   5                    else
 991   5                    {
 992   6                      g_scArrTxComSoft[10]='0';     //Carro =0;
 993   6                    }
 994   5          
 995   5                    g_scArrTxComSoft[11]=ETX;
 996   5                    EscribirCadenaSoft(12);
 997   5      
 998   5                  }
 999   4                  
1000   4      
1001   4      
1002   4                }
1003   3                else
1004   3                {
1005   4      
1006   4                  g_scArrTxComSoft[0]=STX;
1007   4                  g_scArrTxComSoft[1]='w';
1008   4                  g_scArrTxComSoft[2]=((buffer_wie[0]>>4)&0X0f)+0X30;
1009   4                  g_scArrTxComSoft[3]=(buffer_wie[0]&0X0F)+0X30;
1010   4                  g_scArrTxComSoft[4]=((buffer_wie[1]>>4)&0X0f)+0X30;
1011   4                  g_scArrTxComSoft[5]=(buffer_wie[1]&0X0f)+0X30;
1012   4                  g_scArrTxComSoft[6]=((buffer_wie[2]>>4)&0X0f)+0X30;
1013   4                  g_scArrTxComSoft[7]=(buffer_wie[2]&0X0f)+0X30;
1014   4        
1015   4                    g_scArrTxComSoft[8]=',';
1016   4                  g_scArrTxComSoft[9]='0';
1017   4        
1018   4      //-------------------------------------------------------------------------------
1019   4                  if (Send_Tipo_Veh==CARD)
1020   4                  {
1021   5                    if (Tipo_Vehiculo=='H')         // Heavy
1022   5                    {
1023   6                      xTipo_Vehiculo=4;
1024   6                    }
1025   5                    else if (Tipo_Vehiculo=='T')      // Truck
1026   5                    {
1027   6                      xTipo_Vehiculo=3;
1028   6                    }
1029   5                    else if(Tipo_Vehiculo=='B')         // Bycicle
1030   5                    {
1031   6                      xTipo_Vehiculo=2;
1032   6                    }
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 18  

1033   5                    else if(Tipo_Vehiculo=='M')       // Motocycle
1034   5                    {
1035   6                      xTipo_Vehiculo=1;
1036   6                    }
1037   5                    else if(Tipo_Vehiculo=='C')       // Carro
1038   5                    {
1039   6                      xTipo_Vehiculo=0;
1040   6                    }
1041   5                    else                  // Sin categoria
1042   5                    {
1043   6          
1044   6                      if (Dif_Mot_Car==1)
1045   6                      {
1046   7                        if (automovil==0)
1047   7                        {
1048   8                          xTipo_Vehiculo=0;     //Carro =0;      no funciona modificado 23/01/2019
1049   8                        }
1050   7                        else
1051   7                        {
1052   8                          xTipo_Vehiculo=1;       //MOTO = 1
1053   8                        }
1054   7                      }
1055   6                      else
1056   6                      {
1057   7                        xTipo_Vehiculo=0;       //Carro =0;
1058   7                      }
1059   6                      
1060   6                    }
1061   5                    g_scArrTxComSoft[10]=xTipo_Vehiculo+0X30;
1062   5                  }
1063   4                  else
1064   4                  {
1065   5                    if (Dif_Mot_Car==1)
1066   5                    {
1067   6                      if (automovil==0)
1068   6                      {
1069   7                        g_scArrTxComSoft[10]='0';   //Carro =0;   no funcionamodificado 23/01/2019
1070   7                      }
1071   6                      else
1072   6                      {
1073   7                        g_scArrTxComSoft[10]='1';     //MOTO = 1
1074   7                      }
1075   6                    }
1076   5                    else
1077   5                    {
1078   6                      g_scArrTxComSoft[10]='0';     //Carro =0;
1079   6                    }
1080   5                    }
1081   4      //--------------------------------------------------------------------------------  
1082   4                      g_scArrTxComSoft[11]=',';
1083   4                  
1084   4      
1085   4                  send_dataCLK((YearIn-0x30),12);
1086   4                  send_dataCLK((MonthIn-0x30),14);
1087   4                  send_dataCLK((DayIn-0x30),16);
1088   4                  send_dataCLK((HourIn-0x30),18);
1089   4                  send_dataCLK((MinutIn-0x30),20);
1090   4      
1091   4                  if (Off_Line_Salida==1)
1092   4                  {
1093   5                    
1094   5                      g_scArrTxComSoft[22]=',';
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 19  

1095   5                    send_dataCLK((YearOut-0x30),23);
1096   5                    send_dataCLK((MonthOut-0x30),25);
1097   5                    send_dataCLK((DayOut-0x30),27);
1098   5                    send_dataCLK((HourOut-0x30),29);
1099   5                    send_dataCLK((MinutOut-0x30),31);
1100   5                    temp=33;
1101   5                    g_scArrTxComSoft[temp++]=',';
1102   5                    
1103   5                    if (Dato_Placa==1)
1104   5                    {
1105   6      //                Dato_Placa=0;
1106   6      //                for (i=0; i<NumDatosPlate-1; i++)
1107   6                      for (i=0; i<NumDatosPlate; i++)
1108   6                      {
1109   7                        g_scArrTxComSoft[temp++]=buffer_placa[i];
1110   7                      }
1111   6                      g_scArrTxComSoft[temp++]=',';
1112   6                      g_scArrTxComSoft[temp++]=ETX;
1113   6                      EscribirCadenaSoft(temp);
1114   6      
1115   6                    }
1116   5                    else
1117   5                    {
1118   6                        g_scArrTxComSoft[temp++]=' ';
1119   6                      g_scArrTxComSoft[temp++]=',';
1120   6                        g_scArrTxComSoft[temp++]=ETX;
1121   6                      EscribirCadenaSoft(temp);
1122   6                    }
1123   5      
1124   5      //              g_scArrTxComSoft[33]=ETX;
1125   5      //              EscribirCadenaSoft(34);
1126   5                  }
1127   4                  else
1128   4                  {
1129   5                      g_scArrTxComSoft[22]=',';
1130   5                    send_dataCLK((0),23);
1131   5                    send_dataCLK((0),25);
1132   5                    send_dataCLK((0),27);
1133   5                    send_dataCLK((0),29);
1134   5                    send_dataCLK((0),31);
1135   5      
1136   5                    temp=33;
1137   5                    g_scArrTxComSoft[temp++]=',';
1138   5                    
1139   5                    if (Dato_Placa==1)
1140   5                    {
1141   6                      Dato_Placa=0;
1142   6                      for (i=0; i<NumDatosPlate-1; i++)
1143   6                      {
1144   7                        g_scArrTxComSoft[temp++]=buffer_placa[i];
1145   7                      }
1146   6                      g_scArrTxComSoft[temp++]=',';
1147   6                      g_scArrTxComSoft[temp++]=ETX;
1148   6                      EscribirCadenaSoft(temp);
1149   6                    }
1150   5                    else
1151   5                    {
1152   6                        g_scArrTxComSoft[temp++]=' ';
1153   6                      g_scArrTxComSoft[temp++]=',';
1154   6                        g_scArrTxComSoft[temp++]=ETX;
1155   6                      EscribirCadenaSoft(temp);
1156   6                    }
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 20  

1157   5      
1158   5      //              g_scArrTxComSoft[33]=ETX;
1159   5      //              EscribirCadenaSoft(34);
1160   5      
1161   5                  }
1162   4      
1163   4                }
1164   3      
1165   3      //          g_cEstadoTxSoft &=~LECTURA_WIEG_TX;
1166   3      //jp          byte_wie=0x00000000;
1167   3      //          nbitsW=0;
1168   3                g_cEstadoComSoft=ESPERA_RX;
1169   3            }
1170   2      //--------------------------------------------------------------------------------------------------------
             ----------      
1171   2              else if ((g_cEstadoTxSoft&COD_PRINT_TX)==COD_PRINT_TX)            // Envia Ticket/Impresora
1172   2            {
1173   3              g_cEstadoTxSoft &=~COD_PRINT_TX;
1174   3              g_cEstadoComSoft=ESPERA_RX;
1175   3            } 
1176   2      //--------------------------------------------------------------------------------------------------------
             ----------
1177   2          break;
1178   2      //********************************************************************************************************
             -*********
1179   2      //********************************************************************************************************
             -*********
1180   2          case ANALICE_STR_SOF:                                //ANALIZA DATOS RECIBIDOS
1181   2      
1182   2                if (SerieOK==1)
1183   2              {
1184   3                SerieOK=0;
1185   3                for (i=0; i<g_cContByteRx; i++)
1186   3                {
1187   4                  buffer_bus[i]=g_scArrDisplay[i];
1188   4                }
1189   3                tx_bus(g_cContByteRx);
1190   3                txACK=1;
1191   3                g_cEstadoComSoft=ESPERA_RX;
1192   3              }                                       
1193   2      //--------------------------------------------------------------------------------------------------------
             --------
1194   2      //        else if((g_cContByteRx==25)&&(g_scArrRxComSoft[1]==g_cDirBoard)&&(g_scArrRxComSoft[2]=='H'))  //H: HO
             -RA DEL SISTEMA
1195   2              else if((g_cContByteRx==25)&&(g_scArrDisplay[1]==g_cDirBoard)&&(g_scArrDisplay[2]=='H'))    //H: HORA DE
             -L SISTEMA
1196   2              { 
1197   3                  prg_disp();
1198   3                  for (i=0; i<g_cContByteRx; i++)
1199   3                  {
1200   4                    buffer_bus[i]=g_scArrDisplay[i];
1201   4                  }
1202   3                  tx_bus(g_cContByteRx);              //TRANFIERE HORA AL SECUNDARIO
1203   3                
1204   3                  cont(0x80);
1205   3                  vdato('S');
1206   3                  vdato('Y');
1207   3                  vdato('N');
1208   3                  vdato('C');
1209   3                  txACK=1;
1210   3                  g_cEstadoComSoft=ESPERA_RX;
1211   3      
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 21  

1212   3              }
1213   2              else if(g_cContByteRx>=0x06)            //Area de Actuadores
1214   2              {
1215   3                /*envia los cupos al segundario*/
1216   3                if(g_cContByteRx>=0x07)               // modificado jp cmd del num de cupos disponibles
1217   3                 {  
1218   4                  if(g_scArrRxComSoft[1]=='c')      // valido el cmd de cupos q es 'c'
1219   4                  {
1220   5                    
1221   5                  tx_bus(g_cContByteRx);
1222   5                /*
1223   5                    cont(0x80);                         //se envia inf al lcd para pruebas
1224   5                    buffer_Cupo[4]='\0';
1225   5                   lcd_text(0,0,(unsigned char *)  buffer_Cupo);
1226   5                    */
1227   5                    txACK=1;
1228   5                    g_cEstadoComSoft=ESPERA_RX;
1229   5                  }
1230   4                }
1231   3                
1232   3                if(g_scArrRxComSoft[1]=='D')
1233   3                {
1234   4      
1235   4                }
1236   3                else if(g_scArrRxComSoft[1]=='A')
1237   3                {
1238   4      //            lock1=1;
1239   4      //            seg=cte_seg;
1240   4      //            TH0=0X00;                                           
1241   4      //            TL0=0X00;
1242   4      //            TF0=0;        
1243   4                }
1244   3                if(g_scArrRxComSoft[2]=='D')
1245   3                {
1246   4      
1247   4                }
1248   3                else if(g_scArrRxComSoft[2]=='A')
1249   3                {
1250   4                  if (notifyEVP==1)
1251   4                  {
1252   5                    if (InhabilitaPulsoEvPOut==1)
1253   5                    {
1254   6                      if ((Send_Wiegand==1))
1255   6                      {
1256   7                        if (SalidaW==0)
1257   7                        {
1258   8                          lock2=1;            // Alvaro Manda Abrir mensual y tiquete pero notifico
1259   8                          seg=cte_seg+14;
1260   8                          TH0=0X00;           //Inicializa timer                    *           
1261   8                          TL0=0X00;
1262   8                          TF0=0;
1263   8                        }
1264   7                      }
1265   6                    }
1266   5                    else
1267   5                    {
1268   6                      if (SalidaW==0)
1269   6                      {
1270   7                        lock2=1;              // Alvaro Manda Abrir mensual y tiquete pero notifico
1271   7                        seg=cte_seg+14;
1272   7                        TH0=0X00;             //Inicializa timer                    *           
1273   7                        TL0=0X00;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 22  

1274   7                        TF0=0;
1275   7                        }
1276   6                    }
1277   5      
1278   5                  }
1279   4                }
1280   3      //--------------------------------------------------------------------------------------------------------
             --------------------*
1281   3                if (bandera_rx_soft==1)                 //(g_cContByteRx>0x06)                          //Area de Mensajes L1       
1282   3                {
1283   4                  bandera_rx_soft=0;
1284   4      
1285   4                  if ((g_scArrDisplay[5]=='A')&&(g_scArrDisplay[6]=='C')&&(g_scArrDisplay[7]=='E')&&(g_scArrDisplay[8]
             -=='R')&&(g_scArrDisplay[9]=='Q')&&(g_scArrDisplay[10]=='U')&&(g_scArrDisplay[11]=='E')&&(g_scArrDisplay[12]=='S')&&(g_sc
             -ArrDisplay[13]=='E'))
1286   4                  {
1287   5                    SendRtaBus(0xa1);
1288   5                  }
1289   4                    else if ((g_scArrDisplay[5]=='U')&&(g_scArrDisplay[6]=='N')&&(g_scArrDisplay[7]==' ')&&(g_scArrDi
             -splay[8]=='M'))
1290   4                  {
1291   5                    SendRtaBus(UN_MOMENTO);
1292   5                    
1293   5                    g_cEstadoTxSoft &=~LECTURA_COD_TX;
1294   5                    g_cEstadoTxSoft &=~LECTURA_WIEG_TX;
1295   5                    Dato_Placa=0;
1296   5      
1297   5                    Tiquete_Placa=0;
1298   5                    Tiquete_Salida=0;
1299   5                    send_markCashierAut=0;
1300   5      
1301   5                    Rechazo=0;
1302   5                    TimeOut_Codigo=0;
1303   5                    TimeOut_Wiegand=0;
1304   5                    SalidaW=0;
1305   5                    Tipo_Vehiculo=' ';
1306   5                    
1307   5                  }
1308   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='A')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='G')&&(g_scArrDisplay[6]=='R')&&(g_scArrDisplay[7]=='A')&&(g_scArrDisplay[8]=='C')&&
             -(g_scArrDisplay[9]=='I')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='S'))
1309   4                  {
1310   5                    SendMsg(GRACIAS);
1311   5                    }
1312   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='B')&&(g_scArrDisplay[6]=='I')&&(g_scArrDisplay[7]=='E')&&(g_scArrDisplay[8]=='N')&&
             -(g_scArrDisplay[9]=='V')&&(g_scArrDisplay[10]=='E')&&(g_scArrDisplay[11]=='N')&&(g_scArrDisplay[12]=='I')&&(g_scArrDispl
             -ay[13]=='D')&&(g_scArrDisplay[14]=='O'))
1313   4                  {
1314   5                    SendMsg(BIENVENIDO);
1315   5                  }
1316   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='M')&&(g_scArrDisplay[6]=='E')&&(g_scArrDisplay[7]=='N')&&(g_scArrDisplay[8]=='S')&&
             -(g_scArrDisplay[9]=='U')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='L')&&(g_scArrDisplay[12]==' ')&&(g_scArrDispl
             -ay[13]=='N')&&(g_scArrDisplay[14]=='O')&&(g_scArrDisplay[15]==' ')&&(g_scArrDisplay[16]=='E')&&(g_scArrDisplay[17]=='S')
             -&&(g_scArrDisplay[18]=='T')&&(g_scArrDisplay[19]=='A'))
1317   4                  {
1318   5                    SendRtaBus(NO_IN_PARK);
1319   5                  }
1320   4      
1321   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='M')&&(g_scArrDisplay[6]=='E')&&(g_scArrDisplay[7]=='N')&&(g_scArrDisplay[8]=='S')&&
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 23  

             -(g_scArrDisplay[9]=='U')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='L')&&(g_scArrDisplay[12]==' ')&&(g_scArrDispl
             -ay[13]=='Y')&&(g_scArrDisplay[14]=='A')&&(g_scArrDisplay[15]==' ')&&(g_scArrDisplay[16]=='E')&&(g_scArrDisplay[17]=='S')
             -&&(g_scArrDisplay[18]=='T')&&(g_scArrDisplay[19]=='A'))
1322   4                  {
1323   5                    SendRtaBus(IN_PARK);
1324   5                  }
1325   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='M')&&(g_scArrDisplay[6]=='E')&&(g_scArrDisplay[7]=='N')&&(g_scArrDisplay[8]=='S')&&
             -(g_scArrDisplay[9]=='U')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='L')&&(g_scArrDisplay[12]==' ')&&(g_scArrDispl
             -ay[13]=='F')&&(g_scArrDisplay[14]=='U')&&(g_scArrDisplay[15]=='E')&&(g_scArrDisplay[16]=='R')&&(g_scArrDisplay[17]=='A')
             -&&(g_scArrDisplay[18]==' ')&&(g_scArrDisplay[19]=='D')&&(g_scArrDisplay[20]=='E')&&(g_scArrDisplay[21]=='R'))
1326   4                  {
1327   5                    SendRtaBus(EXPIRO);
1328   5                  }
1329   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='M')&&(g_scArrDisplay[6]=='E')&&(g_scArrDisplay[7]=='N')&&(g_scArrDisplay[8]=='S')&&
             -(g_scArrDisplay[9]=='U')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='L')&&(g_scArrDisplay[12]==' ')&&(g_scArrDispl
             -ay[13]=='F')&&(g_scArrDisplay[14]=='U')&&(g_scArrDisplay[15]=='E')&&(g_scArrDisplay[16]=='R')&&(g_scArrDisplay[17]=='A')
             -&&(g_scArrDisplay[18]==' ')&&(g_scArrDisplay[19]=='D')&&(g_scArrDisplay[20]=='E')&&(g_scArrDisplay[21]=='H'))
1330   4                  {
1331   5                    SendRtaBus(HORARIO);
1332   5                  }
1333   4                  else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDispl
             -ay[4]=='X')&&(g_scArrDisplay[5]=='N')&&(g_scArrDisplay[6]=='O')&&(g_scArrDisplay[7]==' ')&&(g_scArrDisplay[8]=='E')&&(g_
             -scArrDisplay[9]=='S')&&(g_scArrDisplay[10]==' ')&&(g_scArrDisplay[11]=='M')&&(g_scArrDisplay[12]=='E')&&(g_scArrDisplay[
             -13]=='N')&&(g_scArrDisplay[14]=='S'))
1334   4                  {
1335   5                    SendRtaBus(NO_MENSUAL);
1336   5                              
1337   5                  }
1338   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='N')&&(g_scArrDisplay[6]=='O')&&(g_scArrDisplay[7]==' ')&&(g_scArrDisplay[8]=='R')&&
             -(g_scArrDisplay[9]=='E')&&(g_scArrDisplay[10]=='G')&&(g_scArrDisplay[11]=='I')&&(g_scArrDisplay[12]=='S')&&(g_scArrDispl
             -ay[13]=='T')&&(g_scArrDisplay[14]=='R'))
1339   4                  {
1340   5                    SendRtaBus(NO_REGIST);
1341   5      
1342   5                  }
1343   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDi
             -splay[4]=='X')&&(g_scArrDisplay[5]=='L')&&(g_scArrDisplay[6]=='O')&&(g_scArrDisplay[7]=='T')&&(g_scArrDisplay[8]=='E')&&
             -(g_scArrDisplay[9]==' ')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='S')&&(g_scArrDisplay[12]=='I')&&(g_scArrDispl
             -ay[13]=='G')&&(g_scArrDisplay[14]=='N'))
1344   4                  {
1345   5                    SendRtaBus(LOT_FULL);
1346   5                  }
1347   4                  //
1348   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDisp
             -lay[4]=='X')&&(g_scArrDisplay[5]=='M')&&(g_scArrDisplay[6]=='E')&&(g_scArrDisplay[7]=='N')&&(g_scArrDisplay[8]=='S')&&(g
             -_scArrDisplay[9]=='U')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='L')&&(g_scArrDisplay[12]==' ')&&(g_scArrDisplay
             -[13]=='E')&&(g_scArrDisplay[14]=='X')&&(g_scArrDisplay[15]=='C')&&(g_scArrDisplay[16]=='E')&&(g_scArrDisplay[17]=='D')&&
             -(g_scArrDisplay[18]=='E'))
1349   4                  {
1350   5                    SendRtaBus(EXCEDE_HORARIO);
1351   5                  }
1352   4                    else if ((g_scArrDisplay[1]=='X')&&(g_scArrDisplay[2]=='X')&&(g_scArrDisplay[3]=='X')&&(g_scArrDisp
             -lay[4]=='X')&&(g_scArrDisplay[5]=='M')&&(g_scArrDisplay[6]=='E')&&(g_scArrDisplay[7]=='N')&&(g_scArrDisplay[8]=='S')&&(g
             -_scArrDisplay[9]=='U')&&(g_scArrDisplay[10]=='A')&&(g_scArrDisplay[11]=='L')&&(g_scArrDisplay[12]==' ')&&(g_scArrDisplay
             -[13]=='N')&&(g_scArrDisplay[14]=='O')&&(g_scArrDisplay[15]==' ')&&(g_scArrDisplay[16]=='P')&&(g_scArrDisplay[17]=='A')&&
             -(g_scArrDisplay[18]=='G'))
1353   4                  {
1354   5                    SendRtaBus(MENSUAL_NO_PAGO);
1355   5                  }
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 24  

1356   4      //--------------------------------------------------------------------------------------------------------
             ------------------
1357   4                  cont(0x80);
1358   4                  for(i=5;(i<21)&&(g_scArrDisplay[i]!=ETX);i++)     /*msj en el display ejemplo (PARQUEADERO)*/
1359   4                  {
1360   5                    vdato(g_scArrDisplay[i]);
1361   5                  }
1362   4                  cont(0xc0);
1363   4                  for(i=21;(i<=38)&&(g_scArrDisplay[i]!=ETX);i++)
1364   4                  {
1365   5                      if (msg_error==0)
1366   5                    {
1367   6                      vdato(g_scArrDisplay[i]);                     /*hora del sistema*/
1368   6                    }
1369   5                  }
1370   4      
1371   4                } //if(g_cContByteRx>0x06)       
1372   3      
1373   3      
1374   3              }
1375   2      //--------------------------------------------------------------------------------------------------------
             ------------------
1376   2              g_cEstadoComSoft=ESPERA_RX;
1377   2              txACK=1;
1378   2            
1379   2          break;
1380   2      //--------------------------------------------------------------------------------------------------------
             ----
1381   2          default:
1382   2            g_cEstadoComSoft=ESPERA_RX;
1383   2          break;
1384   2        
1385   2        }
1386   1      } 
1387          
1388          //*******************************************************************************************
1389          //
1390          //  Main C function that start the interrupt-driven serial I/O.
1391          //
1392          //*******************************************************************************************
1393          void main (void) 
1394          {
1395   1      
1396   1       unsigned char MSGnotify    []= "COMPARACION:    " ;
1397   1       unsigned char msgdir       []= "   Addr:        " ;
1398   1       unsigned char sin_resp     []= " SIN RESPUESTA  " ; 
1399   1       unsigned char resp_NACK    []= " PLACA NO IGUAL " ; 
1400   1       unsigned char SendCode   []= " ENVIANDO DATOS " ; 
1401   1      
1402   1       unsigned char k,i,NumDatValidar;
1403   1       unsigned char PosComa[2];
1404   1       unsigned char temp;
1405   1      
1406   1      //******************************************************************************************* 
1407   1        com_initialize ();                  // Initialize interrupt driven serial I/O       *
1408   1        inicia_wiegand();                 // Inicia wiegand lectrua a 26 complemnto a uno, lectura a 33, 27 lectura a 26 
             -sin complemeto
1409   1       //   EA = 1;                             // Enable global interrupts             *
1410   1        prg_disp();
1411   1      //******************************************************************************************* 
1412   1        TMOD=(TMOD & 0xf0) | 0x01;      //  Coloca el temporizador 0 y 1 en modo 1.  16bITS *
1413   1        TF0=0;                //  Bandera de Timer                *
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 25  

1414   1        TH0=0X00;             //                          *           
1415   1        TL0=0X00;             //                          *
1416   1        TR0=1;                // Run TM2                      *
1417   1      //******************************************************************************************* 
1418   1        lock1=0;              // Relevo                     *
1419   1        lock2=0;
1420   1        ledv=0;                 // Led Pulsador                   *
1421   1        bus_clk=1;
1422   1      //******************************************************************************************* 
1423   1      //  INICIALIZACIONES
1424   1      //*******************************************************************************************
1425   1      
1426   1      
1427   1        toggle=1;
1428   1        TimeOut_Codigo=0;
1429   1        TimeOut_Wiegand=0;
1430   1        TimeOutLinea=TIMEW;
1431   1        seg=cte_seg;
1432   1        retry=0;
1433   1      
1434   1        msg1=0;
1435   1        audio1=0;
1436   1      
1437   1        msg2=0;
1438   1        audio2=0;
1439   1      
1440   1        msg3=0;
1441   1        audio3=0;
1442   1      
1443   1        msg4=0;
1444   1        audio4=0;
1445   1      
1446   1        send_markCashierAut=0;
1447   1        Rechazo=0;
1448   1        Dato_OffLine=0;
1449   1        Tiquete_Placa=0;
1450   1        Tiquete_Salida=0;
1451   1        TimeRetryCmd=0;
1452   1        TimeOut_Send_Acceso=0;
1453   1        Tx_Acceso=0;
1454   1        iTimeEsperaRtaLPR=0;
1455   1        RetryCmd=0;
1456   1      //*******************************************************************************************
1457   1      //  PROGRAMACIONES
1458   1      //*******************************************************************************************
1459   1        ACCESO_USE_LPR=0;                   // 0 = Envia a Evp   1 = Envia al secundario LPR para Decision de Acceso
1460   1        notifyEVP=1;
1461   1        Dif_Mot_Car=1;
1462   1        OrigenTipoVeh=CARD;                 // CARD - LOOP
1463   1      
1464   1      
1465   1        InhabilitaPulsoEvPOut=1;                // Mifare Inhabilta Pulso de Evp...
1466   1                                  // Ticket NO debe Inhabilitar
1467   1        Send_Tipo_Veh=CARD;                 // CARD o LOOP
1468   1        OpenMensual_Apx=0;                  // 
1469   1        Central_ID_OFFLINE=0;
1470   1      //*******************************************************************************************
1471   1      
1472   1        lcd_text(0,0,(unsigned char *) " AccesScan v4.5 ");
1473   1      
1474   1        cont(0xc0);
1475   1        lcd_puts(msgdir);             /*jp se muestra la direccion*/
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 26  

1476   1        ve_dir();
1477   1      //------------------------------------------------------------------------------------------*
1478   1        busy=1;
1479   1        bus_clk=1;
1480   1        if (automovil==1)
1481   1        {
1482   2          
1483   2        }
1484   1      //*******************************************************************************************
1485   1        while (1)
1486   1         {
1487   2      
1488   2            P2=0xff;
1489   2          temp=P2;
1490   2        
1491   2          if((completo == 1) &&(SignalAcceso==0))
1492   2          {
1493   3          
1494   3            if (Habilita_Lectura==1)
1495   3            {
1496   4              TimeOutLinea=TIMEW;             /*tengo el dato wiegand en el orden de access*/
1497   4                id_Access();                  /*tengo el dato en buffer_wie*/
1498   4              
1499   4              limpia_data();                /*limpio los datos*/        
1500   4                
1501   4              if ((ACCESO_USE_LPR==1))
1502   4              {
1503   5          
1504   5                if (iTimeEsperaRtaLPR==0)         /*envio trama para ser transmitida por tcp/ip*/
1505   5                {
1506   6                buffer_bus[0]=STX;
1507   6                buffer_bus[1]='W';
1508   6                buffer_bus[2]=buffer_wie[0];
1509   6                buffer_bus[3]=buffer_wie[1];
1510   6                buffer_bus[4]=buffer_wie[2];
1511   6                buffer_bus[5]=ETX;
1512   6        
1513   6                buffer_wieLPR[0]=buffer_wie[0];
1514   6                buffer_wieLPR[1]=buffer_wie[1];
1515   6                buffer_wieLPR[2]=buffer_wie[2];
1516   6        
1517   6                g_cContByteRx=6;
1518   6                tx_bus(g_cContByteRx);                  /*transmito al pto paralelo*/
1519   6                g_cEstadoTxSoft &=~LECTURA_WIEG_TX;     // Si usa LPR no envia al software. LPR agrega el registro y da
             - Acceso
1520   6                iTimeEsperaRtaLPR=cte_seg*20;
1521   6                }
1522   5                else
1523   5                {
1524   6                g_cEstadoTxSoft &=~LECTURA_WIEG_TX;     // Si usa LPR no envia al software. LPR agrega el registro y da
             - Acceso
1525   6                }
1526   5                
1527   5              }
1528   4              else
1529   4              {
1530   5              buffer_bus[0]=STX;
1531   5              buffer_bus[1]='W';
1532   5              buffer_bus[2]=buffer_wie[0];
1533   5              buffer_bus[3]=buffer_wie[1];
1534   5              buffer_bus[4]=buffer_wie[2];
1535   5              buffer_bus[5]=ETX;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 27  

1536   5              g_cContByteRx=6;
1537   5              tx_bus(g_cContByteRx);
1538   5              g_cEstadoTxSoft=LECTURA_WIEG_TX;
1539   5              SalidaW=0;
1540   5              TimeOut_Wiegand=5;
1541   5                g_cEstadoComSoft=POLL_COM_SOF;
1542   5                AtencComSoft();
1543   5              }
1544   4      
1545   4            } 
1546   3            else
1547   3            {
1548   4              lcd_text(1,0,(unsigned char *) "INHABILITADA... ");
1549   4              g_cEstadoTxSoft &=~LECTURA_WIEG_TX;
1550   4            }
1551   3      
1552   3      
1553   3              if (Central_ID_OFFLINE==1)
1554   3              {
1555   4                if (((buffer_wie[0]==0x76)&&(buffer_wie[1]==0xd6)&&(buffer_wie[2]==0x0b))||((buffer_wie[0]==0x24)&&(b
             -uffer_wie[1]==0x54)&&(buffer_wie[2]==0xe4))||((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x00)&&(buffer_wie[2]==0xd5))||((bu
             -ffer_wie[0]==0x5F)&&(buffer_wie[1]==0xd7)&&(buffer_wie[2]==0x84)))
1556   4                {
1557   5                  lock1=1;
1558   5                  lock2=1;
1559   5                  seg=cte_seg+14;
1560   5                  TH0=0X00;           //Inicializa timer                    *           
1561   5                  TL0=0X00;
1562   5                  TF0=0;
1563   5                }
1564   4                else if (((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x00)&&(buffer_wie[2]==0xf2))||((buffer_wie[0]==0x60
             -)&&(buffer_wie[1]==0x40)&&(buffer_wie[2]==0x94))||((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x00)&&(buffer_wie[2]==0xf3))|
             -|((buffer_wie[0]==0x37)&&(buffer_wie[1]==0x36)&&(buffer_wie[2]==0x24)))
1565   4                {
1566   5                  lock1=1;
1567   5                  lock2=1;
1568   5                  seg=cte_seg+14;
1569   5                  TH0=0X00;           //Inicializa timer                    *           
1570   5                  TL0=0X00;
1571   5                  TF0=0;
1572   5                }
1573   4                else if (((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x01)&&(buffer_wie[2]==0x10))||((buffer_wie[0]==0x7f
             -)&&(buffer_wie[1]==0x75)&&(buffer_wie[2]==0x44))||((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x01)&&(buffer_wie[2]==0x11))|
             -|((buffer_wie[0]==0x17)&&(buffer_wie[1]==0xee)&&(buffer_wie[2]==0x24)))
1574   4                {
1575   5                  lock1=1;
1576   5                  lock2=1;
1577   5                  seg=cte_seg+14;
1578   5                  TH0=0X00;           //Inicializa timer                    *           
1579   5                  TL0=0X00;
1580   5                  TF0=0;
1581   5                }
1582   4                else if (((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x4f)&&(buffer_wie[2]==0xd7))||((buffer_wie[0]==0x67
             -)&&(buffer_wie[1]==0x17)&&(buffer_wie[2]==0xb4))||((buffer_wie[0]==0x94)&&(buffer_wie[1]==0xea)&&(buffer_wie[2]==0x75))|
             -|((buffer_wie[0]==0x7c)&&(buffer_wie[1]==0xde)&&(buffer_wie[2]==0x34)))
1583   4                {
1584   5                  lock1=1;
1585   5                  lock2=1;
1586   5                  seg=cte_seg+14;
1587   5                  TH0=0X00;           //Inicializa timer                    *           
1588   5                  TL0=0X00;
1589   5                  TF0=0;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 28  

1590   5                }
1591   4                else if (((buffer_wie[0]==0x94)&&(buffer_wie[1]==0xeb)&&(buffer_wie[2]==0x58))||((buffer_wie[0]==0x17
             -)&&(buffer_wie[1]==0x16)&&(buffer_wie[2]==0xd4))||((buffer_wie[0]==0x8f)&&(buffer_wie[1]==0x42)&&(buffer_wie[2]==0xd6)))
1592   4                {
1593   5                  lock1=1;
1594   5                  lock2=1;
1595   5                  seg=cte_seg+14;
1596   5                  TH0=0X00;           //Inicializa timer                    *           
1597   5                  TL0=0X00;
1598   5                  TF0=0;
1599   5                }
1600   4                else if (((buffer_wie[0]==0x95)&&(buffer_wie[1]==0x1d)&&(buffer_wie[2]==0xbc))||((buffer_wie[0]==0x26
             -)&&(buffer_wie[1]==0x12)&&(buffer_wie[2]==0x84)))
1601   4                {
1602   5                  lock1=1;
1603   5                  lock2=1;
1604   5                  seg=cte_seg+14;
1605   5                  TH0=0X00;           //Inicializa timer                    *           
1606   5                  TL0=0X00;
1607   5                  TF0=0;
1608   5                }
1609   4                else if (((buffer_wie[0]==0x82)&&(buffer_wie[1]==0x88)&&(buffer_wie[2]==0x14))||((buffer_wie[0]==0x51
             -)&&(buffer_wie[1]==0xc1)&&(buffer_wie[2]==0x14)))
1610   4                {
1611   5                  lock1=1;
1612   5                  lock2=1;
1613   5                  seg=cte_seg+14;
1614   5                  TH0=0X00;           //Inicializa timer                    *           
1615   5                  TL0=0X00;
1616   5                  TF0=0;
1617   5                }
1618   4              }
1619   3      
1620   3      //--------------------------------------------------------------------------------------------------------
             ----*
1621   3        
1622   3            }
1623   2            else
1624   2            {
1625   3                
1626   3              if (completo==1)
1627   3              {
1628   4                id_Access();                                        /*se muestra el nuemro de la tarjeta pero no hay presencia*/
1629   4            
1630   4                limpia_data();  
1631   4                SendRtaBus(ERROR_LOOP);                               /*envia un msj a segundario q hay un error en el loop*/
1632   4                lcd_text(1,0,(unsigned char *) "ERROR EN LOOP...");
1633   4                g_cEstadoTxSoft &=~LECTURA_WIEG_TX;
1634   4              }
1635   3              
1636   3      
1637   3            }
1638   2        
1639   2      //------------------------------------------------------------------------------------------*
1640   2      //    INTERRUPCION DEL AUXILIAR
1641   2      //------------------------------------------------------------------------------------------*
1642   2          if (ready==0)             //Recibe del procesador Aux (Interrupcion generada del Aux)
1643   2          {
1644   3            buffer_bus[0]=0xff;
1645   3            buffer_bus[1]=0xff;
1646   3            rx_bus();
1647   3          /*
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 29  

1648   3            lcd_text(0,0,(unsigned char *) " pto P0 ");     //jp
1649   3            temp=0xff;
1650   3            while(temp){temp--;}//jp
1651   3      //-----------------------------------  TEST
1652   3            for (k=0; k<num_data; k++)
1653   3              {
1654   3              tx_chr(buffer_bus[k]);
1655   3            }
1656   3      //-----------------------------------   
1657   3          */
1658   3            if (num_data!=0)
1659   3            {
1660   4                if ((num_data==1)&&(buffer_bus[0]==ACK))                        // ERRORES
1661   4              {
1662   5                Habilita_Lectura=1;
1663   5              }
1664   4      
1665   4              if ((num_data==1)&&(buffer_bus[0]>=0xDF)&&(buffer_bus[0]<=0xef))            // ERRORES
1666   4              {
1667   5                  prg_disp();
1668   5                if  ((buffer_bus[0]==0xe2)||(buffer_bus[0]==0xe3)||(buffer_bus[0]==0xe4))
1669   5                {
1670   6                    cont(0xc0);
1671   6                  for (k=0;err_mifare[k]!='\0';k++)
1672   6                  {
1673   7                      vdato(err_mifare[k]);
1674   7                  }
1675   6                  cont(0xcE);
1676   6                  vdato((buffer_bus[0]&0x0f)+0x30);
1677   6                }
1678   5      
1679   5                else if(buffer_bus[0]==0xe0)
1680   5                {
1681   6                      cont(0xc0);
1682   6                  for (k=0;sin_sensor[k]!='\0';k++)
1683   6                  {
1684   7                      vdato(sin_sensor[k]);
1685   7                  }
1686   6      
1687   6                }
1688   5                else if(buffer_bus[0]==0xe1)
1689   5                {
1690   6                      
1691   6                  lcd_text(1,0,(unsigned char *) "TARJETA INVALIDA");
1692   6                   
1693   6                }
1694   5                else if(buffer_bus[0]==0xe5)
1695   5                {
1696   6                      cont(0xc0);
1697   6                  for (k=0;err_cod[k]!='\0';k++)
1698   6                  {
1699   7                      vdato(err_cod[k]);
1700   7                  }
1701   6                }
1702   5                else if(buffer_bus[0]==0xe6)
1703   5                {
1704   6                    cont(0xc0);
1705   6                  for (k=0;err_in[k]!='\0';k++)
1706   6                  {
1707   7                      vdato(err_in[k]);
1708   7                  }
1709   6                }
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 30  

1710   5                else if(buffer_bus[0]==0xe7)
1711   5                {
1712   6                
1713   6                  cont(0xc0);
1714   6                  lcd_puts((unsigned char *)"NO REGISTRA PAGO");
1715   6                  
1716   6                  
1717   6                  wait_long1(10000);
1718   6                  //{
1719   6                    //  vdato(err_sinpago[k]);
1720   6                  //}
1721   6                }
1722   5                else if(buffer_bus[0]==0xe8)
1723   5                {
1724   6                  cont(0xc0);
1725   6                  for (k=0;err_gracia[k]!='\0';k++)
1726   6                  {
1727   7                      vdato(err_gracia[k]);
1728   7                  }         
1729   6                }
1730   5      
1731   5                else if(buffer_bus[0]==0xe9)
1732   5                {
1733   6                  cont(0xc0);
1734   6                  for (k=0;err_out[k]!='\0';k++)
1735   6                  {
1736   7                      vdato(err_out[k]);
1737   7                  }         
1738   6                }
1739   5                else if(buffer_bus[0]==0xea)
1740   5                {
1741   6                  cont(0xc0);
1742   6                  for (k=0;err_data[k]!='\0';k++)
1743   6                  {
1744   7                      vdato(err_data[k]);
1745   7                  }         
1746   6                }
1747   5                else if(buffer_bus[0]==0xeB)
1748   5                {
1749   6                  cont(0xc0);
1750   6                  for (k=0;err_Caja[k]!='\0';k++)
1751   6                  {
1752   7                      vdato(err_Caja[k]);
1753   7                  }         
1754   6                }
1755   5                else if(buffer_bus[0]==0xec)
1756   5                {
1757   6                  cont(0xc0);
1758   6                  for (k=0;tarjeta_venc[k]!='\0';k++)
1759   6                  {
1760   7                      vdato(tarjeta_venc[k]);
1761   7                  }         
1762   6                }
1763   5                else if (buffer_bus[0]==0xed)
1764   5                {
1765   6                  cont(0xc0);
1766   6                  for (k=0;sin_resp[k]!='\0';k++)
1767   6                  {
1768   7                      vdato(sin_resp[k]);
1769   7                  }         
1770   6                }
1771   5                else if (buffer_bus[0]==0xee)
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 31  

1772   5                {
1773   6                  cont(0xc0);
1774   6                  for (k=0;resp_NACK[k]!='\0';k++)
1775   6                  {
1776   7                      vdato(resp_NACK[k]);
1777   7                  }         
1778   6                }
1779   5      
1780   5                else if (buffer_bus[0]==0xeF)
1781   5                {
1782   6                  cont(0xc0);
1783   6                  vdato('T');
1784   6                  vdato('A');
1785   6                  vdato('R');
1786   6                  vdato('J');
1787   6                  vdato('E');
1788   6                  vdato('T');
1789   6                  vdato('A');
1790   6                  vdato(' ');
1791   6                  vdato('A');
1792   6                  vdato('T');
1793   6                  vdato('A');
1794   6                  vdato('S');
1795   6                  vdato('C');
1796   6                  vdato('A');
1797   6                  vdato('D');
1798   6                  vdato('A');
1799   6      
1800   6      //            lock1=1;
1801   6                  Atascado=1;
1802   6                  seg=cte_seg;
1803   6                }
1804   5                else if (buffer_bus[0]==0xDF)
1805   5                { 
1806   6                  prg_disp();
1807   6                  cont(0xc0);
1808   6                  lcd_puts((unsigned char *) "TAR. SIN FORMATO");
1809   6                  
1810   6                }
1811   5                msg_error=1;
1812   5                seg=cte_seg;
1813   5                TH0=0X00;               //Inicializa timer            *           
1814   5                TL0=0X00;
1815   5                TF0=0;
1816   5              }
1817   4              else if ((num_data==1)&&(buffer_bus[0]==0xa0))
1818   4              {
1819   5                audio1=1;
1820   5                msg1=1;
1821   5                seg=cte_seg;
1822   5              }
1823   4              else if ((num_data==1)&&(buffer_bus[0]==0xa1))
1824   4              {
1825   5                audio2=1;
1826   5                msg2=1;
1827   5                seg=cte_seg;
1828   5                lcd_text(0,0,(unsigned char *) "DIRIJASE A CAJA ");
1829   5              }
1830   4              else if ((num_data==1)&&(buffer_bus[0]==0xa2))
1831   4              {
1832   5                audio3=1;
1833   5                msg3=1;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 32  

1834   5                seg=cte_seg;
1835   5              }
1836   4              else if ((num_data==1)&&(buffer_bus[0]==0xA3))
1837   4              {
1838   5                audio4=1;
1839   5                msg4=1;
1840   5                seg=cte_seg+14;
1841   5              }
1842   4              else if ((num_data==1)&&(buffer_bus[0]==0XAF))
1843   4              {
1844   5                cont(0xc0);
1845   5      
1846   5                vdato('C');
1847   5                vdato('O');
1848   5                vdato('N');
1849   5                vdato('T');
1850   5                vdato('.');
1851   5                vdato(' ');
1852   5                vdato('E');
1853   5                vdato('V');
1854   5                vdato('N');
1855   5                vdato(' ');
1856   5                vdato('I');
1857   5                vdato('N');
1858   5                vdato('I');
1859   5                vdato('C');
1860   5                vdato('I');
1861   5                vdato('.');
1862   5      
1863   5              }
1864   4              else if ((num_data==1)&&(buffer_bus[0]=='N'))
1865   4              {
1866   5                notifyEVP=1;
1867   5      
1868   5                cont(0x80);
1869   5                for (k=0;MSGnotify[k]!='\0';k++)
1870   5                {
1871   6                  vdato(MSGnotify[k]);
1872   6                }
1873   5                cont(0x8D);
1874   5                vdato('N');
1875   5                if (ACCESO_USE_LPR==1)
1876   5                {
1877   6                  vdato(' ');
1878   6                  vdato('M');
1879   6                }
1880   5                
1881   5              }
1882   4              else if ((num_data==1)&&(buffer_bus[0]=='S'))
1883   4              {
1884   5                notifyEVP=0;
1885   5                cont(0x80);
1886   5                for (k=0;MSGnotify[k]!='\0';k++)
1887   5                {
1888   6                  vdato(MSGnotify[k]);
1889   6                }
1890   5                cont(0x8D);
1891   5                vdato('S');
1892   5                if (ACCESO_USE_LPR==1)
1893   5                {
1894   6                  vdato(' ');
1895   6                  vdato('M');
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 33  

1896   6                }
1897   5      
1898   5      
1899   5      
1900   5              }
1901   4              else if ((num_data==1)&&(buffer_bus[0]=='P'))
1902   4              {
1903   5                notifyEVP=0;
1904   5                cont(0xc0);
1905   5                for (k=0;matchPlate[k]!='\0';k++)
1906   5                {
1907   6                  vdato(matchPlate[k]);
1908   6                }
1909   5              }
1910   4              else if ((num_data==1)&&(buffer_bus[0]=='D'))
1911   4              {
1912   5                cont(0xc0);
1913   5                for (k=0;SendCode[k]!='\0';k++)
1914   5                {
1915   6                  vdato(SendCode[k]);
1916   6                }
1917   5              }
1918   4              else if ((num_data==1)&&(buffer_bus[0]==0XF1))
1919   4              {
1920   5                cont(0xc0);
1921   5      
1922   5                vdato('U');
1923   5                vdato('N');
1924   5                vdato(' ');
1925   5                vdato('M');
1926   5                vdato('O');
1927   5                vdato('M');
1928   5                vdato('E');
1929   5                vdato('N');
1930   5                vdato('T');
1931   5                vdato('O');
1932   5                vdato('.');
1933   5                vdato('.');
1934   5                vdato('.');
1935   5                vdato(' ');
1936   5                vdato(' ');
1937   5                vdato(' ');
1938   5      
1939   5      
1940   5      
1941   5              }
1942   4              else if ((num_data==1)&&(buffer_bus[0]==PICO_PLACA))
1943   4              {
1944   5                cont(0xc0);
1945   5      
1946   5                vdato('P');
1947   5                vdato('I');
1948   5                vdato('C');
1949   5                vdato('O');
1950   5                vdato(' ');
1951   5                vdato('Y');
1952   5                vdato(' ');
1953   5                vdato('P');
1954   5                vdato('L');
1955   5                vdato('A');
1956   5                vdato('C');
1957   5                vdato('A');
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 34  

1958   5                vdato('.');
1959   5                vdato('.');
1960   5                vdato('.');
1961   5                vdato(' ');
1962   5      
1963   5              }
1964   4              else if ((num_data==1)&&(buffer_bus[0]==0XF8))
1965   4              {
1966   5                cont(0xc0);
1967   5      
1968   5                vdato('V');
1969   5                vdato('E');
1970   5                vdato('H');
1971   5                vdato('I');
1972   5                vdato('.');
1973   5                vdato(' ');
1974   5                vdato('I');
1975   5                vdato('N');
1976   5                vdato('V');
1977   5                vdato('A');
1978   5                vdato('L');
1979   5                vdato('I');
1980   5                vdato('D');
1981   5                vdato('O');
1982   5                vdato('.');
1983   5                vdato('.');
1984   5                vdato('.');
1985   5      
1986   5      
1987   5              }
1988   4              else if ((num_data==1)&&(buffer_bus[0]==0XF9))
1989   4              {
1990   5                cont(0xc0);
1991   5      
1992   5                vdato('S');
1993   5                vdato('A');
1994   5                vdato('L');
1995   5                vdato('I');
1996   5                vdato('D');
1997   5                vdato('A');
1998   5                vdato(' ');
1999   5                vdato('R');
2000   5                vdato('E');
2001   5                vdato('C');
2002   5                vdato('H');
2003   5                vdato('A');
2004   5                vdato('Z');
2005   5                vdato('A');
2006   5                vdato('D');
2007   5                vdato('A');
2008   5      
2009   5      
2010   5              }
2011   4              else if ((num_data==1)&&(buffer_bus[0]==SIN_TARJETAS))
2012   4              {
2013   5                cont(0xc0);
2014   5      
2015   5                vdato('S');
2016   5                vdato('I');
2017   5                vdato('N');
2018   5                vdato(' ');
2019   5                vdato('T');
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 35  

2020   5                vdato('A');
2021   5                vdato('R');
2022   5                vdato('J');
2023   5                vdato('E');
2024   5                vdato('T');
2025   5                vdato('A');
2026   5                vdato('S');
2027   5                vdato(' ');
2028   5                vdato(' ');
2029   5                vdato(' ');
2030   5                vdato(' ');
2031   5      
2032   5      
2033   5              }
2034   4              else if ((num_data==1)&&(buffer_bus[0]==HORARIO))
2035   4              {
2036   5                cont(0xc0);
2037   5      
2038   5                vdato('F');
2039   5                vdato('U');
2040   5                vdato('E');
2041   5                vdato('R');
2042   5                vdato('A');
2043   5                vdato(' ');
2044   5                vdato('D');
2045   5                vdato('E');
2046   5                vdato(' ');
2047   5                vdato('H');
2048   5                vdato('O');
2049   5                vdato('R');
2050   5                vdato('A');
2051   5                vdato('R');
2052   5                vdato('I');
2053   5                vdato('O');
2054   5      
2055   5      
2056   5              }
2057   4              else if ((num_data==1)&&(buffer_bus[0]==IN_HORARIO))
2058   4              {
2059   5                cont(0x80);
2060   5      
2061   5                vdato(' ');
2062   5                vdato('E');
2063   5                vdato('N');
2064   5                vdato('T');
2065   5                vdato('R');
2066   5                vdato('A');
2067   5                vdato('D');
2068   5                vdato('A');
2069   5                vdato(' ');
2070   5                vdato('F');
2071   5                vdato('U');
2072   5                vdato('E');
2073   5                vdato('R');
2074   5                vdato('A');
2075   5                vdato(' ');
2076   5                vdato(' ');
2077   5      
2078   5                cont(0xc0);
2079   5      
2080   5                vdato('D');
2081   5                vdato('E');
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 36  

2082   5                vdato(' ');
2083   5                vdato('H');
2084   5                vdato('O');
2085   5                vdato('R');
2086   5                vdato('A');
2087   5                vdato('R');
2088   5                vdato('I');
2089   5                vdato('O');
2090   5                vdato(' ');
2091   5                vdato('-');
2092   5                vdato('C');
2093   5                vdato('A');
2094   5                vdato('J');
2095   5                vdato('A');
2096   5      
2097   5              }
2098   4              else if ((num_data==1)&&(buffer_bus[0]==DiaX))
2099   4              {
2100   5                cont(0x80);
2101   5      
2102   5                vdato('D');
2103   5                vdato('I');
2104   5                vdato('A');
2105   5                vdato(' ');
2106   5                vdato('D');
2107   5                vdato('E');
2108   5                vdato(' ');
2109   5                vdato('A');
2110   5                vdato('C');
2111   5                vdato('C');
2112   5                vdato('E');
2113   5                vdato('S');
2114   5                vdato('O');
2115   5                vdato(' ');
2116   5                vdato(' ');
2117   5                vdato(' ');
2118   5      
2119   5                cont(0xc0);
2120   5      
2121   5                vdato('I');
2122   5                vdato('N');
2123   5                vdato('V');
2124   5                vdato('A');
2125   5                vdato('L');
2126   5                vdato('I');
2127   5                vdato('D');
2128   5                vdato('O');
2129   5                vdato(' ');
2130   5                vdato(' ');
2131   5                vdato(' ');
2132   5                vdato(' ');
2133   5                vdato(' ');
2134   5                vdato(' ');
2135   5                vdato(' ');
2136   5                vdato(' ');
2137   5      
2138   5              }
2139   4              else if ((num_data==1)&&(buffer_bus[0]==0XFb))
2140   4              {
2141   5                cont(0xc0);
2142   5      
2143   5                vdato('E');
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 37  

2144   5                vdato('R');
2145   5                vdato('R');
2146   5                vdato('O');
2147   5                vdato('R');
2148   5                vdato(' ');
2149   5                vdato('T');
2150   5                vdato('R');
2151   5                vdato('A');
2152   5                vdato('N');
2153   5                vdato('S');
2154   5                vdato('P');
2155   5                vdato('O');
2156   5                vdato('R');
2157   5                vdato('T');
2158   5                vdato('E');
2159   5        
2160   5              }
2161   4              else if ((num_data==1)&&(buffer_bus[0]==0XFC))
2162   4              {
2163   5                cont(0xc0);
2164   5      
2165   5                vdato('N');
2166   5                vdato('O');
2167   5                vdato(' ');
2168   5                vdato('E');
2169   5                vdato('S');
2170   5                vdato(' ');
2171   5                vdato('M');
2172   5                vdato('E');
2173   5                vdato('N');
2174   5                vdato('S');
2175   5                vdato('U');
2176   5                vdato('A');
2177   5                vdato('L');
2178   5                vdato('.');
2179   5                vdato('.');
2180   5                vdato('.');
2181   5        
2182   5              }
2183   4              else if ((num_data==1)&&(buffer_bus[0]==0XFD))
2184   4              {
2185   5                cont(0xc0);
2186   5      
2187   5                vdato('N');
2188   5                vdato('O');
2189   5                vdato(' ');
2190   5                vdato('E');
2191   5                vdato('S');
2192   5                vdato(' ');
2193   5                vdato('D');
2194   5                vdato('E');
2195   5                vdato(' ');
2196   5                vdato('R');
2197   5                vdato('O');
2198   5                vdato('T');
2199   5                vdato('A');
2200   5                vdato('C');
2201   5                vdato('I');
2202   5                vdato('O');
2203   5        
2204   5              }
2205   4              else if ((num_data==1)&&(buffer_bus[0]==0XFe))
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 38  

2206   4              {
2207   5                cont(0xc0);
2208   5      
2209   5                vdato('B');
2210   5                vdato('I');
2211   5                vdato('E');
2212   5                vdato('N');
2213   5                vdato('V');
2214   5                vdato('E');
2215   5                vdato('N');
2216   5                vdato('I');
2217   5                vdato('D');
2218   5                vdato('O');
2219   5                vdato(' ');
2220   5                vdato(' ');
2221   5                vdato(' ');
2222   5                vdato(' ');
2223   5                vdato(' ');
2224   5                vdato(' ');
2225   5        
2226   5              }
2227   4              else if ((num_data==1)&&(buffer_bus[0]==0XFF))
2228   4              {
2229   5                cont(0x80);
2230   5      
2231   5                vdato('G');
2232   5                vdato('R');
2233   5                vdato('A');
2234   5                vdato('C');
2235   5                vdato('I');
2236   5                vdato('A');
2237   5                vdato('S');
2238   5                vdato('.');
2239   5                vdato('.');
2240   5                vdato('.');
2241   5                vdato(' ');
2242   5                vdato(' ');
2243   5                vdato(' ');
2244   5                vdato(' ');
2245   5                vdato(' ');
2246   5                vdato(' ');
2247   5        
2248   5              }
2249   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='i'))  // (num_data>=18)&&
2250   4              {
2251   5      
2252   5                  prg_disp();
2253   5                  
2254   5                  lcd_text(0,0,(unsigned char *) "Fecha Hora:     ");   //  muestra en el lcd la fecha                  
             -                   *
2255   5      
2256   5      //            cont(0x80);
2257   5      //            for (k=0;informa[k]!='\0';k++)
2258   5      //            {
2259   5      //              vdato(informa[k]);
2260   5      //            }
2261   5            
2262   5                  cont(0xc0); 
2263   5                  vdata_clk(buffer_bus[2]);     //año  [2]
2264   5                  vdato('/');
2265   5      
2266   5                  vdata_clk(buffer_bus[3]);     //mes
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 39  

2267   5                  vdato('/');
2268   5      
2269   5                  vdata_clk(buffer_bus[4]);   //dia
2270   5                  vdato(' ');
2271   5      
2272   5                  vdata_clk(buffer_bus[5]);   //hora
2273   5                  vdato(':');
2274   5      
2275   5                  vdata_clk(buffer_bus[6]);   //minuto
2276   5                    
2277   5                    vdata_clk(buffer_bus[7]);   //segundo
2278   5      
2279   5                  cont(0x8c);
2280   5                  if (buffer_bus[8]==1)
2281   5                  {
2282   6                    vdato('D');
2283   6                    vdato('o');
2284   6                    vdato('m');
2285   6                  
2286   6                  }
2287   5                  else if (buffer_bus[8]==2)
2288   5                  {
2289   6                    vdato('L');
2290   6                    vdato('u');
2291   6                    vdato('n');
2292   6      
2293   6                  }
2294   5                  else if (buffer_bus[8]==3)
2295   5                  {
2296   6                    vdato('M');
2297   6                    vdato('a');
2298   6                    vdato('r');
2299   6      
2300   6                  }
2301   5                  else if (buffer_bus[8]==4)
2302   5                  {
2303   6                    vdato('M');
2304   6                    vdato('i');
2305   6                    vdato('e');
2306   6                  }
2307   5                  else if (buffer_bus[8]==5)
2308   5                  {
2309   6                    vdato('J');
2310   6                    vdato('u');
2311   6                    vdato('e');
2312   6                  }
2313   5                  else if (buffer_bus[8]==6)
2314   5                  {
2315   6                    vdato('V');
2316   6                    vdato('i');
2317   6                    vdato('e');
2318   6                  }
2319   5                  else if (buffer_bus[8]==7)
2320   5                  {
2321   6                    vdato('S');
2322   6                    vdato('a');
2323   6                    vdato('b');
2324   6                  }                         
2325   5              }
2326   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='I'))  // (num_data>=18)&&
2327   4              {
2328   5                cont(0x80);
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 40  

2329   5                for (k=0;serie[k]!='\0';k++)
2330   5                {
2331   6                  vdato(serie[k]);
2332   6                }
2333   5                  temp=num_data-2;
2334   5                cont(0xc0);
2335   5                num_chr=0;
2336   5                for (k=0; k<temp; k++)
2337   5                {
2338   6                  if (buffer_bus[k+2]==ETX)
2339   6                  {
2340   7                    k=temp+1;
2341   7                  }
2342   6                  else
2343   6                  {
2344   7                    vdato(buffer_bus[k+2]);
2345   7                    num_chr++;
2346   7                  }
2347   6                }
2348   5                for (k=0; k<(16-num_chr); k++)
2349   5                {
2350   6                  vdato(' ');
2351   6                }
2352   5              }
2353   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='D'))  // (num_data>=18)&&
2354   4              {
2355   5                prg_disp();
2356   5                 cont(0x80);
2357   5                lcd_puts((unsigned char *) "ID_CLIENTE:");
2358   5                  for(k=2;;k++)
2359   5                  {
2360   6                    if(buffer_bus[k]!=';')
2361   6                     {
2362   7                      vdato(buffer_bus[k]);
2363   7                     }  else break;
2364   6                  }
2365   5                cont(0xc0);
2366   5                k++;
2367   5                  lcd_puts((unsigned char *) "COD_PARK:");
2368   5                    for(i=2;;k++)
2369   5                    {
2370   6                      if(buffer_bus[k]!=';')
2371   6                      {
2372   7                        vdato(buffer_bus[k]);
2373   7                      }else break;
2374   6                    }
2375   5                }
2376   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='W')&&(buffer_bus[num_data-1]==ETX)&&(num_data==18))  /
             -/  
2377   4              {
2378   5                
2379   5                iTimeEsperaRtaLPR=0;
2380   5                
2381   5                Dato_OffLine=0;
2382   5                SalidaW=1;
2383   5      
2384   5                buffer_wie[0]=buffer_bus[4];
2385   5                buffer_wie[1]=buffer_bus[3];
2386   5                buffer_wie[2]=buffer_bus[2];
2387   5      
2388   5                YearIn=buffer_bus[6];
2389   5                MonthIn=buffer_bus[7];
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 41  

2390   5                DayIn=buffer_bus[8];
2391   5                HourIn=buffer_bus[9];
2392   5                MinutIn=buffer_bus[10];
2393   5        
2394   5                YearOut=buffer_bus[11];
2395   5                MonthOut=buffer_bus[12];
2396   5                DayOut=buffer_bus[13];
2397   5                HourOut=buffer_bus[14];
2398   5                MinutOut=buffer_bus[15];
2399   5                Tipo_Vehiculo=buffer_bus[16];
2400   5                 
2401   5      
2402   5                g_cEstadoTxSoft |= LECTURA_WIEG_TX;
2403   5                TimeOut_Wiegand=5;
2404   5      
2405   5                
2406   5              }
2407   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='W')) //  
2408   4              {
2409   5                iTimeEsperaRtaLPR=0;
2410   5                
2411   5                Dato_OffLine=0;
2412   5                SalidaW=0;
2413   5      
2414   5                buffer_wie[0]=buffer_bus[4];
2415   5                buffer_wie[1]=buffer_bus[3];
2416   5                buffer_wie[2]=buffer_bus[2];
2417   5                g_cEstadoTxSoft |= LECTURA_WIEG_TX;
2418   5                TimeOut_Wiegand=5;
2419   5      
2420   5                
2421   5              }
2422   4              else if ((buffer_bus[0]==0x02)&&((buffer_bus[1]=='M'))) //  
2423   4              {
2424   5      
2425   5                iTimeEsperaRtaLPR=0;
2426   5                 lcd_wiegand();
2427   5              //  lcd_text(0,0,(unsigned char *) "LECT.           ");
2428   5                //  cont(0x87);               // Visualiza FC + ID
2429   5      //ojo         ve_fc(buffer_wie[0]);
2430   5              //  cont(0x8b);               // Visualiza FC + ID
2431   5      //          ve_id(buffer_wie[1],buffer_wie[2]);
2432   5      
2433   5                Dato_OffLine=0;
2434   5                buffer_wie[0]=buffer_bus[4];
2435   5                buffer_wie[1]=buffer_bus[3];
2436   5                buffer_wie[2]=buffer_bus[2];
2437   5                g_cEstadoTxSoft |= LECTURA_WIEG_TX;
2438   5                TimeOut_Wiegand=5;
2439   5                TimeOut_Send_Acceso=cte_seg*5;
2440   5      
2441   5              }
2442   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='w')&&(buffer_bus[num_data-1]==ETX))  //   inf del mc au
             -x    jp
2443   4              {
2444   5                
2445   5                iTimeEsperaRtaLPR=0;
2446   5      
2447   5                Dato_OffLine=1;
2448   5                Off_Line_Salida=0;
2449   5                Dato_Placa=0;
2450   5      
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 42  

2451   5                // buffer_bus[5];    Parte del codigo de la tarjeta 4 bytes
2452   5              
2453   5                buffer_wie[0]=buffer_bus[4];
2454   5                buffer_wie[1]=buffer_bus[3];
2455   5                buffer_wie[2]=buffer_bus[2];
2456   5      
2457   5                YearIn=buffer_bus[6];
2458   5                MonthIn=buffer_bus[7];
2459   5                DayIn=buffer_bus[8];
2460   5                HourIn=buffer_bus[9];
2461   5                MinutIn=buffer_bus[10];
2462   5        
2463   5                if (num_data==18)
2464   5                {
2465   6                  YearOut=buffer_bus[11];
2466   6                  MonthOut=buffer_bus[12];
2467   6                  DayOut=buffer_bus[13];
2468   6                  HourOut=buffer_bus[14];
2469   6                  MinutOut=buffer_bus[15];
2470   6                  Tipo_Vehiculo=buffer_bus[16];
2471   6                  Off_Line_Salida=1;
2472   6                  Dato_Placa=0;
2473   6                                     // ojo jp
2474   6                   //lcd_text(1,0,(unsigned char *) "q pasa");
2475   6                   //while(1){};//jp
2476   6                }
2477   5                else if (num_data>18)
2478   5                {
2479   6      
2480   6                  YearOut=buffer_bus[11];
2481   6                  MonthOut=buffer_bus[12];
2482   6                  DayOut=buffer_bus[13];
2483   6                  HourOut=buffer_bus[14];
2484   6                  MinutOut=buffer_bus[15];
2485   6      
2486   6                  Tipo_Vehiculo=buffer_bus[num_data-2];
2487   6                    // lcd_text(1,0,(unsigned char *) buffer_bus[num_data-2]);  //jp
2488   6                  //   while(1){};//jp
2489   6                  Off_Line_Salida=1;
2490   6                  Dato_Placa=1;
2491   6                  NumDatosPlate=0;
2492   6                  Max_Len_Placa=10;
2493   6        
2494   6                  for (k=16; k<num_data-2; k++)
2495   6                  {
2496   7                    if (buffer_bus[k]!=ETX)
2497   7                    {
2498   8                      buffer_placa[k-16]=buffer_bus[k];
2499   8                      NumDatosPlate++;
2500   8                    }
2501   7                    else
2502   7                    {
2503   8                      k=num_data;
2504   8                    }
2505   7                    
2506   7                  }
2507   6                }
2508   5                else
2509   5                {
2510   6                  Tipo_Vehiculo=buffer_bus[11];
2511   6                  //   lcd_text(1,0,(unsigned char *) buffer_bus[11]);  //jp
2512   6                  //   while(1){};//jp
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 43  

2513   6                  Off_Line_Salida=0;
2514   6                }
2515   5                
2516   5      
2517   5                g_cEstadoTxSoft |= LECTURA_WIEG_TX;
2518   5                TimeOut_Wiegand=10;
2519   5       
2520   5              }
2521   4              else if ((buffer_bus[0]==STX)&&((buffer_bus[1]=='P')||(buffer_bus[1]=='T')||(buffer_bus[1]=='V')||(buf
             -fer_bus[1]=='E')||(buffer_bus[1]=='G')))  //  
2522   4              {
2523   5                iTimeEsperaRtaLPR=0;
2524   5                
2525   5                Rechazo=buffer_bus[1];
2526   5                len_buffer=num_data;
2527   5      //          len_buffer=buffer_bus[2];               //  Numero de Datos recibidos del Secunadario
2528   5                BorraLCD_L1();
2529   5                send_markCashierAut=0;                  // Incializa Marca de Liquidacion en Cajero
2530   5                Flag_Dcto=0;                      // Inicializa bandera de Salida con descuento
2531   5                cont(0x80);                       // Visualiza Lectura (hasta 1er separador)
2532   5                for (k=3; k<len_buffer; k++)            // Chequea datos
2533   5                {
2534   6                  if (((buffer_bus[k]>='0')&&(buffer_bus[k]<='9'))||((buffer_bus[k]>='A')&&(buffer_bus[k]<='Z'))||(buf
             -fer_bus[k]=='-')||(buffer_bus[k]=='.'))
2535   6                  {
2536   7                    datos_validos=1;
2537   7                  }
2538   6                  else
2539   6                  {
2540   7                    datos_validos=0;
2541   7                    k=len_buffer+1;
2542   7                  }
2543   6                  vdato(buffer_bus[k]);
2544   6                }
2545   5                if  (datos_validos==1)
2546   5                {
2547   6      //--------------------------------------------------------------------------------------------------------
             ------------------------------
2548   6                  i=0;
2549   6                  Tipo_Vehiculo=0;                 // Borra Tipo
2550   6                  for (k=0; k<len_buffer; k++)           // Busca Separador de Datos para Tipo Vehiculo
2551   6                  {
2552   7                    if (buffer_bus[k]=='.')
2553   7                    {
2554   8                      Tipo_Vehiculo=buffer_bus[k+1];      // Almacena Tipo Vehiculo de la tarjeta
2555   8                      k=len_buffer;
2556   8                    }
2557   7                  }
2558   6                  if (Tipo_Vehiculo!=0)
2559   6                  {
2560   7                    len_buffer=len_buffer-0x05;           // Quita: STX Letra #  punto TipoVehiculo = 5 Caracteres del tota
             -l
2561   7                  }
2562   6      //--------------------------------------------------------------------------------------------------------
             ------------------------------- 
2563   6                  g_cEstadoTxSoft |= LECTURA_COD_TX;
2564   6                  
2565   6                  for (k=0; k<len_buffer; k++)
2566   6                  {
2567   7                    buffer_ticket[k]=buffer_bus[k+3];       //
2568   7                  }
2569   6      
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 44  

2570   6                  //Habilita_Lectura=0;               // Inhabilita Aproximacion
2571   6                  //lcd_text(1,0,(unsigned char *) "APX. NO ACTIVA  ");
2572   6                }
2573   5                TimeOutLinea=TIMEW;
2574   5                TimeOut_Codigo=30;
2575   5              }
2576   4      //--------------------------------------------------------------------------------------------------------
             ------------------------------*
2577   4              else if ((buffer_bus[0]==STX)&&((buffer_bus[1]=='a'))&&(buffer_bus[num_data-1]==ETX)) //      STX "a" Ti
             -quete - Fecha_In - LPR ETX
2578   4              {
2579   5                  
2580   5      //            tx_chr(ACK);
2581   5      
2582   5                  iTimeEsperaRtaLPR=0;
2583   5      
2584   5      
2585   5                  Tiquete_Placa=1;
2586   5                  Tiquete_Salida=0;
2587   5                  NumChrTicket=0;
2588   5      
2589   5                  for (k=2; k<num_data; k++)            // Busca Separador de Datos para Tipo Vehiculo
2590   5                  {
2591   6                    if (buffer_bus[k]=='-')
2592   6                    {
2593   7                      Ini_Fecha=k+1;
2594   7                      k=num_data;
2595   7                    }
2596   6                  }
2597   5                  
2598   5                
2599   5      
2600   5                  for (k=2; k<Ini_Fecha-1; k++)
2601   5                  {
2602   6                              
2603   6                    buffer_ticket[k-2]=buffer_bus[k];       //
2604   6                    NumChrTicket++;
2605   6                  }
2606   5                  
2607   5      
2608   5                    YearIn=buffer_bus[Ini_Fecha++];
2609   5                  MonthIn=buffer_bus[Ini_Fecha++];
2610   5                  DayIn=buffer_bus[Ini_Fecha++];
2611   5                  HourIn=buffer_bus[Ini_Fecha++];
2612   5                  MinutIn=buffer_bus[Ini_Fecha++];
2613   5      
2614   5      
2615   5                  Num_Char_LPR=0;
2616   5                  for (k=Ini_Fecha+1; k<num_data-1; k++)
2617   5                  {
2618   6                    buffer_placa[Num_Char_LPR++]=buffer_bus[k];
2619   6                  }
2620   5                  
2621   5                              
2622   5                  g_cEstadoTxSoft |= LECTURA_COD_TX;
2623   5                  TimeOutLinea=TIMEW;
2624   5                  TimeOut_Codigo=30;            
2625   5      
2626   5      
2627   5              }
2628   4      //--------------------------------------------------------------------------------------------------------
             ------------------------------*
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 45  

2629   4              else if (((buffer_bus[0]==STX)&&(buffer_bus[num_data-1]==ETX))&&((buffer_bus[1]=='m')||(buffer_bus[1]=
             -='n')||(buffer_bus[1]=='o')||(buffer_bus[1]=='A')||(buffer_bus[1]=='R'))) //  STX *** "m" "n" "o" *** ETX
2630   4              {
2631   5                if (buffer_bus[1]=='n')
2632   5                {
2633   6                  iTimeEsperaRtaLPR=0;
2634   6                  
2635   6                  ACCESO_USE_LPR=0;
2636   6                  cont(0x80);
2637   6                  for (k=0;MSGnotify[k]!='\0';k++)
2638   6                  {
2639   7                    vdato(MSGnotify[k]);
2640   7                  }
2641   6                  cont(0x8D);
2642   6                  (notifyEVP==1)?(vdato('N')):(vdato('S'));
2643   6                  
2644   6                  vdato(' ');
2645   6                  vdato('N');
2646   6      
2647   6      
2648   6                }
2649   5                else if (buffer_bus[1]=='m')
2650   5                {
2651   6                  ACCESO_USE_LPR=1;
2652   6      
2653   6                  cont(0x80);
2654   6                  for (k=0;MSGnotify[k]!='\0';k++)
2655   6                  {
2656   7                    vdato(MSGnotify[k]);
2657   7                  }
2658   6                  cont(0x8D);
2659   6                  (notifyEVP==1)?(vdato('N')):(vdato('S'));
2660   6                  
2661   6                  vdato(' ');
2662   6                  vdato('M');
2663   6                  
2664   6      
2665   6      
2666   6      
2667   6                }
2668   5                else if (buffer_bus[1]=='o')
2669   5                {
2670   6                  if (buffer_bus[2]=='0')
2671   6                  {
2672   7                    ACCESO_USE_LPR=0;
2673   7                    iTimeEsperaRtaLPR=0;
2674   7      
2675   7                    cont(0x80);
2676   7                    for (k=0;MSGnotify[k]!='\0';k++)
2677   7                    {
2678   8                      vdato(MSGnotify[k]);
2679   8                    }
2680   7                    cont(0x8D);
2681   7                    (notifyEVP==1)?(vdato('N')):(vdato('S'));
2682   7                    
2683   7                    vdato(' ');
2684   7                    vdato('o');
2685   7      
2686   7                  }
2687   6                  else if (buffer_bus[2]=='1')
2688   6                  {
2689   7                    ACCESO_USE_LPR=1;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 46  

2690   7                    cont(0x80);
2691   7                    for (k=0;MSGnotify[k]!='\0';k++)
2692   7                    {
2693   8                      vdato(MSGnotify[k]);
2694   8                    }
2695   7                    cont(0x8D);
2696   7                    (notifyEVP==1)?(vdato('N')):(vdato('S'));
2697   7                    
2698   7                    vdato(' ');
2699   7                    vdato('M');
2700   7                  }
2701   6                }
2702   5                else if (buffer_bus[1]=='A')              // Acepta de LPR
2703   5                {
2704   6                  if (iTimeEsperaRtaLPR!=0)
2705   6                  {
2706   7                    iTimeEsperaRtaLPR=0;
2707   7      
2708   7                    buffer_wie[0]=buffer_wieLPR[0];
2709   7                    buffer_wie[1]=buffer_wieLPR[1];
2710   7                    buffer_wie[2]=buffer_wieLPR[2];
2711   7                    g_cEstadoTxSoft |= LECTURA_WIEG_TX;
2712   7                    TimeOut_Wiegand=5;
2713   7                    SalidaW=0;
2714   7                  }
2715   6       
2716   6                }
2717   5                else if (buffer_bus[1]=='R')            // Rechaza de LPR
2718   5                {
2719   6                      iTimeEsperaRtaLPR=0;
2720   6                    cont(0x80);
2721   6                    for (k=0;MSGnegado[k]!='\0';k++)
2722   6                    {
2723   7                      vdato(MSGnegado[k]);
2724   7                    }
2725   6       
2726   6                }
2727   5                buffer_bus[1]=0xff;                 
2728   5       
2729   5              }
2730   4      //--------------------------------------------------------------------------------------------------------
             ------------------------------*
2731   4              else if ((buffer_bus[0]==STX)&&((buffer_bus[1]=='s')||(buffer_bus[1]=='C'))&&(buffer_bus[num_data-1]==
             -ETX))  //      STX "s" Tiquete - Fecha_In - Fecha Out - LPR ETX
2732   4              {
2733   5                  
2734   5                  iTimeEsperaRtaLPR=0;
2735   5      
2736   5                  Tiquete_Placa=1;
2737   5                  Tiquete_Salida=1;
2738   5                  NumChrTicket=0;
2739   5      
2740   5                  if (buffer_bus[1]=='C')
2741   5                  {
2742   6                    send_markCashierAut=1;
2743   6                  }
2744   5                  else
2745   5                  {
2746   6                    send_markCashierAut=0;
2747   6                  }
2748   5      
2749   5      
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 47  

2750   5      
2751   5                  for (k=2; k<num_data; k++)            // Busca Separador de Datos para Tipo Vehiculo
2752   5                  {
2753   6                    if (buffer_bus[k]=='-')
2754   6                    {
2755   7                      Ini_Dcto=k+1;
2756   7                      k=num_data;
2757   7                    }
2758   6                  }
2759   5      
2760   5                  Cod_Dcto=buffer_bus[Ini_Dcto];
2761   5      
2762   5                  for (k=2; k<Ini_Dcto-1; k++)
2763   5                  {
2764   6                    buffer_ticket[k-2]=buffer_bus[k];       //
2765   6                    NumChrTicket++;
2766   6                  }
2767   5      
2768   5                  
2769   5                  Ini_Fecha=Ini_Dcto+2;
2770   5      
2771   5      
2772   5                    YearIn=buffer_bus[Ini_Fecha++];
2773   5                  MonthIn=buffer_bus[Ini_Fecha++];
2774   5                  DayIn=buffer_bus[Ini_Fecha++];
2775   5                  HourIn=buffer_bus[Ini_Fecha++];
2776   5                  MinutIn=buffer_bus[Ini_Fecha++];
2777   5      
2778   5                  Ini_Fecha++;
2779   5      
2780   5                  YearOut=buffer_bus[Ini_Fecha++];
2781   5                  MonthOut=buffer_bus[Ini_Fecha++];
2782   5                  DayOut=buffer_bus[Ini_Fecha++];
2783   5                  HourOut=buffer_bus[Ini_Fecha++];
2784   5                  MinutOut=buffer_bus[Ini_Fecha++];
2785   5      
2786   5                  Ini_Fecha++;
2787   5      
2788   5                  Tipo_Vehiculo=buffer_bus[Ini_Fecha++];
2789   5      
2790   5                  Num_Char_LPR=0;
2791   5                              
2792   5                  g_cEstadoTxSoft |= LECTURA_COD_TX;
2793   5                  TimeOutLinea=TIMEW;
2794   5                  TimeOut_Codigo=30;
2795   5                            
2796   5      
2797   5      
2798   5              }
2799   4              else if ((buffer_bus[0]==0x02)&&(buffer_bus[1]=='d')&&(buffer_bus[num_data-1]==ETX)&&(num_data==9)) //
             -    DINERO de SALDO
2800   4              {
2801   5                BorraLCD_L1();  
2802   5                  cont(0x80); 
2803   5      
2804   5                vdato('S');
2805   5                vdato('a');
2806   5                vdato('l');
2807   5                vdato('d');
2808   5                vdato('o');
2809   5                vdato(' ');
2810   5                vdato('D');
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 48  

2811   5                vdato('i');
2812   5                vdato('s');
2813   5                vdato('p');
2814   5                vdato('o');
2815   5                vdato('n');
2816   5                vdato('i');
2817   5                vdato('b');
2818   5                vdato('l');
2819   5                vdato('e'); 
2820   5      
2821   5                BorraLCD_L2();
2822   5                cont(0xc0);
2823   5                
2824   5                for (k=2; k<8; k++)
2825   5                {
2826   6                  vdato(buffer_bus[k]);
2827   6                }       
2828   5              }
2829   4              else                          //
2830   4              {
2831   5      //--------------------------------------------------------------------------------------------------------
             ------------------------------*
2832   5                len_buffer=num_data;                  //  Numero de Datos recibidos del Secunadario
2833   5                BorraLCD_L1();
2834   5      //--------------------------------------------------------------------------------------------------------
             ------------------------------*
2835   5                Tipo_Vehiculo=0;                  // Borra Tipo
2836   5                for (k=0; k<len_buffer; k++)            // Busca Separador de Datos para Tipo Vehiculo
2837   5                {
2838   6                  if (buffer_bus[k]=='.')
2839   6                  {
2840   7                    Tipo_Vehiculo=buffer_bus[k+1];        // Almacena Tipo Vehiculo de la tarjeta
2841   7                    k=len_buffer;
2842   7                  }
2843   6                }
2844   5                if (Tipo_Vehiculo!=0)               // H T B M C (LETRAS DEL TIPO DE VEHICULO)
2845   5                {
2846   6                    len_buffer=len_buffer-0x02;           // Quita: punto TipoVehiculo = 2 Caracteres del total
2847   6                }
2848   5      //--------------------------------------------------------------------------------------------------------
             -------------------------------
2849   5                send_markCashierAut=0;                 // Incializa Marca de Liquidacion en Cajero
2850   5                Flag_Dcto=0;                     // Inicializa bandera de Salida con descuento
2851   5                i=0;
2852   5                for (k=0; k<len_buffer; k++)             // Busca Separador de Datos
2853   5                {
2854   6                  if (buffer_bus[k]=='-')
2855   6                  {
2856   7                    PosComa[i++]=k;
2857   7                  }
2858   6                }
2859   5      //--------------------------------------------------------------------------------------------------------
             -------------------------------
2860   5                (i!=0)?(NumDatValidar=PosComa[0]+1):(NumDatValidar=len_buffer);   // EXTRAE SOLO EL CODIGO PARA VALID
             -AD DATOS
2861   5      //--------------------------------------------------------------------------------------------------------
             -------------------------------
2862   5                cont(0x80);                       // Visualiza Lectura (hasta 1er separador)
2863   5                for (k=0; k<NumDatValidar; k++)           // Chequea datos
2864   5                {
2865   6                  if (((buffer_bus[k]>='0')&&(buffer_bus[k]<='9'))||((buffer_bus[k]>='A')&&(buffer_bus[k]<='Z'))||(buf
             -fer_bus[k]=='-')||(buffer_bus[k]=='.'))
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 49  

2866   6                  {
2867   7                    datos_validos=1;
2868   7                  }
2869   6                  else
2870   6                  {
2871   7                    datos_validos=0;
2872   7                    k=NumDatValidar+1;
2873   7                  }
2874   6                  vdato(buffer_bus[k]);
2875   6                }
2876   5      //----------------------------------------------------------------------
2877   5                if  (datos_validos==1)
2878   5                {
2879   6                  iTimeEsperaRtaLPR=0;
2880   6                  
2881   6                  g_cEstadoTxSoft |= LECTURA_COD_TX;
2882   6                
2883   6                  //Habilita_Lectura=0;               // Inhabilita Aproximacion
2884   6                  //lcd_text(1,0,(unsigned char *) "APX. NO ACTIVA  ");
2885   6              
2886   6                  if (i!=0)
2887   6                  {
2888   7                    if (i==1)
2889   7                    {
2890   8                      if ((len_buffer-1-PosComa[0])==1)       // Solo Cod Descuento, Evalua cantidad de datos si es 1 xq e
             -s solo codigo Dcto
2891   8                      {
2892   9                        for (k=0; k<len_buffer; k++)
2893   9                        {
2894  10                          buffer_ticket[k]=buffer_bus[k];
2895  10                    
2896  10                        }
2897   9                        Flag_Dcto=1;
2898   9                        Cod_Dcto= buffer_ticket[len_buffer-1];
2899   9                        vdato('D');
2900   9                        vdato(Cod_Dcto);
2901   9                        len_buffer=len_buffer-2;                
2902   9                      }
2903   8                      else                      // Solo Liquidacion en Cajero Posee mas de un dato, o sea la fecha
2904   8                      {
2905   9                        Flag_Dcto=0;
2906   9                        for (k=0; k<PosComa[0]; k++)
2907   9                        {
2908  10                          buffer_ticket[k]=buffer_bus[k];
2909  10                          
2910  10                        }
2911   9                                          
2912   9                        if ((len_buffer-1-PosComa[0])==5)     // 5 datos de: YMDHM  (Año Mes Dia Hor Min)
2913   9                        {
2914  10                          send_markCashierAut=1;
2915  10      
2916  10                          vdato('C');
2917  10                          vdato('a');
2918  10                          vdato('j');
2919  10                          vdato('e');
2920  10                          vdato('r');
2921  10                          vdato('o');
2922  10      
2923  10                          Ini_Fecha=PosComa[0]+1; 
2924  10                                            
2925  10                          YearIn=buffer_bus[Ini_Fecha++];
2926  10                          MonthIn=buffer_bus[Ini_Fecha++];
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 50  

2927  10                          DayIn=buffer_bus[Ini_Fecha++];
2928  10                          HourIn=buffer_bus[Ini_Fecha++];
2929  10                          MinutIn=buffer_bus[Ini_Fecha];
2930  10                          
2931  10                        }
2932   9                        len_buffer=PosComa[0];
2933   9                      } 
2934   8                    }
2935   7                    else                            // Posee Codigo de descuento y Liquidado en Cajero
2936   7                    {
2937   8                        for (k=0; k<PosComa[0]; k++)
2938   8                      {
2939   9                        buffer_ticket[k]=buffer_bus[k];
2940   9                      }
2941   8                      
2942   8                      Flag_Dcto=1;
2943   8                      Cod_Dcto= buffer_ticket[PosComa[0]+1];
2944   8                      
2945   8                      
2946   8                      send_markCashierAut=1;
2947   8                      Ini_Fecha=PosComa[1]+1;
2948   8                                          
2949   8                      YearIn=buffer_bus[Ini_Fecha++];
2950   8                      MonthIn=buffer_bus[Ini_Fecha++];
2951   8                      DayIn=buffer_bus[Ini_Fecha++];
2952   8                      HourIn=buffer_bus[Ini_Fecha++];
2953   8                      MinutIn=buffer_bus[Ini_Fecha];
2954   8      
2955   8                      len_buffer=PosComa[0];                                
2956   8                    }
2957   7                  }
2958   6                  else                            // Dato sin nada fuera de lo normal.
2959   6                  {
2960   7                    for (k=0; k<len_buffer; k++)
2961   7                    {
2962   8                      buffer_ticket[k]=buffer_bus[k];
2963   8                    }
2964   7                      Flag_Dcto=0;
2965   7                    send_markCashierAut=0;
2966   7                  }
2967   6      
2968   6                  TimeOutLinea=TIMEW;
2969   6                  TimeOut_Codigo=30;
2970   6                }
2971   5      //---------------------------------------------------------------------         
2972   5                }
2973   4            }
2974   3            else
2975   3            {
2976   4      //        cont(0x8E);
2977   4      //        temp=(buffer_bus[0]&0xf0);
2978   4      //        temp>>=4;
2979   4      //        vdato(temp);
2980   4      //        vdato((buffer_bus[0]&0x0f)+0x30);
2981   4      
2982   4            }
2983   3          }
2984   2      
2985   2          if(TF0==1)
2986   2          {
2987   3            TF0=0;
2988   3      //----------------------------------------------------------------------------------------------*
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 51  

2989   3            if (TimeRetryCmd!=0)
2990   3            {
2991   4              TimeRetryCmd--;
2992   4              if (TimeRetryCmd==0)
2993   4              {
2994   5                RetryCmd=1;
2995   5              }
2996   4            }
2997   3      //----------------------------------------------------------------------------------------------*
2998   3            if (TimeOut_Send_Acceso!=0)
2999   3            {
3000   4              TimeOut_Send_Acceso--;
3001   4            }
3002   3            if (OpenMensual_Apx!=0)
3003   3            {
3004   4              OpenMensual_Apx--;
3005   4            }
3006   3      //----------------------------------------------------------------------------------------------*
3007   3            if (iTimeEsperaRtaLPR!=0)
3008   3            {
3009   4              iTimeEsperaRtaLPR--;
3010   4              if (iTimeEsperaRtaLPR==0)
3011   4              {
3012   5                  buffer_wie[0]=buffer_wieLPR[0];
3013   5                  buffer_wie[1]=buffer_wieLPR[1];
3014   5                  buffer_wie[2]=buffer_wieLPR[2];
3015   5                  g_cEstadoTxSoft |= LECTURA_WIEG_TX;
3016   5                  TimeOut_Wiegand=5;
3017   5                  SalidaW=0;
3018   5              }
3019   4            }
3020   3      //----------------------------------------------------------------------------------------------*
3021   3            if (SignalAcceso==0)
3022   3            {
3023   4              if ((seg==cte_seg/2)||(seg==0))
3024   4              {
3025   5                if (toggle==1)
3026   5                {
3027   6                  ledv=0;
3028   6                  toggle=0;
3029   6                }
3030   5                else
3031   5                {
3032   6                  ledv=1;
3033   6                  toggle=1;
3034   6                }
3035   5              }
3036   4            }
3037   3            else
3038   3            {
3039   4              ledv=1;
3040   4              Habilita_Lectura=1;               // Habilita Lectura
3041   4            }
3042   3      //----------------------------------------------------------------------------------------------*
3043   3            seg--;
3044   3            if (seg==0)
3045   3            {
3046   4                if (FueraLinea==1)
3047   4              {
3048   5                if (Seg_OFF!=0)
3049   5                {
3050   6                  Seg_OFF--;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 52  

3051   6                }
3052   5                if (Seg_OFF==0)
3053   5                {
3054   6                  buffer_bus[0]=OFF_LINE;   
3055   6                  tx_bus(1);
3056   6                  Seg_OFF=5;
3057   6                }
3058   5                }
3059   4              else
3060   4              {
3061   5                Seg_OFF=5;  
3062   5              }
3063   4                if (TimeOut_Codigo!=0)
3064   4              {
3065   5                TimeOut_Codigo--;
3066   5                if (TimeOut_Codigo==0)
3067   5                {
3068   6                  g_cEstadoTxSoft &=~LECTURA_COD_TX;
3069   6                  Rechazo=0;
3070   6      
3071   6                  Tiquete_Placa=0;
3072   6                  Tiquete_Salida=0;
3073   6                  Tipo_Vehiculo=' ';
3074   6                  send_markCashierAut=0;
3075   6                  if (FueraLinea==1)
3076   6                  {
3077   7                    BorraLCD_L1();
3078   7                    }
3079   6                }
3080   5              }
3081   4                if (TimeOut_Wiegand!=0)
3082   4              {
3083   5                TimeOut_Wiegand--;
3084   5                if (TimeOut_Wiegand==0)
3085   5                {
3086   6                  g_cEstadoTxSoft &=~LECTURA_WIEG_TX;
3087   6                  SalidaW=0;
3088   6                  Dato_Placa=0;
3089   6      //            Off_Line_Salida=0;
3090   6                }
3091   5              }
3092   4              if (TimeOutLinea!=0)
3093   4              {
3094   5                TimeOutLinea--;
3095   5                if (TimeOutLinea==0)                      /*fuera de linea*/
3096   5                {
3097   6                  TimeOutLinea=TIMEW;
3098   6                  cont(0x80);
3099   6                  for (k=0;k<16;k++)
3100   6                  {
3101   7                      vdato(' ');
3102   7                  }
3103   6                  g_cEstadoTxSoft &=~LECTURA_COD_TX;
3104   6                  g_cEstadoTxSoft &=~LECTURA_WIEG_TX;
3105   6                  g_cEstadoTxSoft &=~COD_PRINT_TX;
3106   6                  FueraLinea=1;
3107   6                  Rechazo=0;
3108   6                  Dato_Placa=0;
3109   6                  send_markCashierAut=0;
3110   6                  Tiquete_Placa=0;
3111   6                  Tiquete_Salida=0;
3112   6                  Dato_Placa=0;
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 53  

3113   6                  cont(0xc0);
3114   6                  for (k=0;linea[k]!='\0';k++)
3115   6                  {
3116   7                      vdato(linea[k]);
3117   7                  }
3118   6                  buffer_bus[0]=OFF_LINE;   
3119   6                  tx_bus(1);
3120   6                }
3121   5              }
3122   4               
3123   4      
3124   4              Atascado=0;
3125   4              lock1=0;
3126   4              lock2=0;
3127   4      
3128   4              audio1=0;
3129   4              msg1=0;
3130   4              audio2=0;
3131   4              msg2=0;
3132   4              audio3=0;
3133   4              msg3=0;
3134   4              audio4=0;
3135   4              msg4=0;
3136   4      
3137   4            
3138   4              seg=cte_seg;
3139   4              TH0=0X00;               //Inicializa timer                  *           
3140   4              TL0=0X00;
3141   4              TF0=0;
3142   4              msg_error=0;
3143   4      
3144   4      
3145   4            }
3146   3      
3147   3          }
3148   2      //********************************************************************************************************
             -***
3149   2          if ((RetryCmd==1)&&(ready==1))
3150   2          {
3151   3              RetryCmd=0;
3152   3            for (temp=0; temp<NumDatRetry; temp++)
3153   3            {
3154   4              buffer_bus[temp]=BufferRetry[temp];
3155   4            }
3156   3            tx_bus(NumDatRetry);
3157   3          }
3158   2      //********************************************************************************************************
             -***
3159   2          if (txACK==1)
3160   2          {
3161   3            tx_chr(ACK);                        
3162   3            txACK=0;
3163   3          }
3164   2      //********************************************************************************************************
             -***
3165   2          if( ((g_cEstadoComSoft==POLL_COM_SOF)||(g_cEstadoComSoft==ANALICE_STR_SOF)))  
3166   2          {                                        
3167   3        
3168   3      
3169   3            AtencComSoft();
3170   3          }
3171   2      //********************************************************************************************************
C51 COMPILER V9.59.0.0   PRINCIPAL_MF                                                      03/24/2021 20:14:16 PAGE 54  

             -***
3172   2          if ((Tx_Acceso==1)&&(ready==1))
3173   2          { 
3174   3            Tx_Acceso=0;
3175   3            buffer_bus[0]=ACCESO;
3176   3            tx_bus(1);
3177   3          
3178   3          //  lcd_text(0,0,(unsigned char *) "ENVIANDO ACCESO ");
3179   3      
3180   3              buffer_bus[0]=0x00;
3181   3            tx_bus(1);
3182   3          }           
3183   2      //***********************************************************************************************
3184   2          relevos_aux();
3185   2        }
3186   1        }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =  14601    ----
   CONSTANT SIZE    =    243    ----
   XDATA SIZE       =    515     112
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     38       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
